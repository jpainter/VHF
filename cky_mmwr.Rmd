---
title: Ebola Virus Disease Contact Reporting and Outbreak Response Monitoring, Conakry,
  Guinea, August-November, 2014
author: John Painter (Corresponding author), Benjamin Dahl, Fatima Coronado, Mathieu
  Bangerts, Michael Martin, Guenael Rodier, William Perera, Boubacar Diallo, (Stephan
  - MSF) (WHO DB admins), Jon E. Tongren
date: "Friday, October 24, 2014"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 6.5
---

\openup 1em  

```{r setup, echo=FALSE, results='hide', message=FALSE, warning=FALSE }
# options(tz="GMT+0")
# Sys.setenv(TZ='GMT+0')

library(knitr)
opts_chunk$set( echo=FALSE, message=FALSE, comment="", 
                warning = FALSE, results='asis', 
                fig.width = 6.5, fig.height = 4,
                cache = FALSE)

library(XLConnect, quietly=TRUE)
library(lubridate)
library(reshape)  # use for rename() function

library(rgeos)
library(sp)

suppressPackageStartupMessages(library(ggplot2))
library(scales)
library(grid)
library(RColorBrewer)

# library(devtools)
# devtools::install_github("hadley/tidyr")
library(stringr)
library(tidyr) # install from github (CRAN version not working...)
library(dplyr, quietly=TRUE) # order is important...

```


```{r data, echo=FALSE, message=FALSE}

# cleaned data from 'dashboard.R'
# for updated data, run: 
# source('dashboard.R')
# load('case_guinea_sl.rda')  

### Warning: this data is missing recordxs....

SeptemberOctober = new_interval(ymd('2014-SEP-01'), ymd('2014-OCT-31') )
AugustNovember = new_interval(ymd('2014-AUG-01'), ymd('2014-NOV-30') )

load('regions.rda')
Region = regions %>%  # table includes Region, DistrictRes, SCRes
  select(-SCRes) %>% # remove SCRes
  unique()

#....so use same VHF data used to find cases-contacts
load('cases.guinea.rda')

data = cases.guinea %>% 
  merge(Region, all.x = TRUE, by= 'DistrictRes') %>%
  mutate( 
    month = months(dateOnset),
    daysToIso = as.numeric( as.Date(DateIsolationCurrent) - as.Date(DateOnset) )  ,
    Age = as.integer(Age) ,
    ages = ifelse( AgeUnit %in% 'Ans', Age*12, Age ), 
    Gender = ifelse( Gender %in% '', NA, as.integer(Gender) ),
    HCW = factor(HCW)
    ) 

data.cky = data %>% filter( Region %in% 'Conakry') %>% 
  filter(dateOnset %within% AugustNovember ) 

data.kindia = data %>% filter( Region %in% 'Kindia') %>%
  filter(dateOnset %within% AugustNovember )

data.forrest = data %>% filter( Region %in% 'Nzérékoré') %>% 
  filter(dateOnset %within% AugustNovember )  


# contacts...
load('contacts.rda') # see nameMatch.R

load('regions.rda')
Region = regions %>%  # table includes Region, DistrictRes, SCRes
  select(-SCRes) %>% # remove SCRes
  unique()

contact.cky  = contacts %>% 
  merge(Region, all.x = TRUE, by.x= 'District', by.y ='DistrictRes' ) %>%
  filter(Region %in% c('Conakry', 'Kindia') )

#  contact.cky %>%  count(District)

```

## New Cases that were known contacts. 

The number of cases who were known contacts was 35 (`r percent(35/134)`) of 134 total cases in Conakry during September and October, 2014.  During the same period in the five districts of Conakry, the percentage of cases who were known contacts was 42% (5 of 12) in Dixinn, 9% (2 of 23) in Kaloum, 23% (3 of 13) in Matam, 17% (8 of 47) in Matoto, and 31% (11 of 36) in Ratoma (Figure 4). Additionally, we 16% (6 of 38) of cases were known contacts but were missing address data ('Unknown').     

```{r sourceCases}
load('keys.rda')

# There are a few multiple contact-case pairs do to duplicates. 
# all duplicates have same source case.  The following removes the duplicates
key. = keys %>% 
  group_by(caseID) %>% filter(row_number(contactID)==1) %>%
  as.data.frame()

d = 
  data.cky %>%
  left_join( key.[, 1:2], by = c('ID' = 'caseID')) %>%
  mutate( knownContact = ifelse(is.na(contactID), 'Not Followed*', 'Followed'), 
          daysToIso = as.numeric( as.Date(DateIsolationCurrent) - as.Date(DateOnset) )
          ) %>%
  select( ID, knownContact, daysToIso, ages, HCW, Gender) %>% 
  group_by(knownContact) %>%
  summarise(  n = n(), 
              Age = sprintf("%s", 
                            format(median(floor(ages/12), na.rm = TRUE), nsmall = 1) ),
              Under5 = sprintf("%s%%", 
                            format(round( 100*sum(ifelse(ages/12 <5, 1, 0), na.rm = TRUE)/n, 1) ) ),
              Male = sprintf("%s%%", 
                             round(100*sum(Gender-1, na.rm = TRUE)/n, 1) ) , #1-Masculine, 2-Feminine
              HCW = sprintf( '%s%%', 
                             round(sum(HCW, na.rm = TRUE)/n, 1) ) ,# 0-no, 1-Yes
              Iso = sprintf("%s", 
                            format(mean(daysToIso, na.rm = TRUE), nsmall = 1) )
             )

t = t(d) %>% as.data.frame()
colnames(t) = c('Known Contact', 'Not Known Contact')
rownames(t)[6] = 'Healthcare Worker'
rownames(t)[3] = 'Age: Median (years)'
rownames(t)[4] = 'Age: Under 5 years'
rownames(t)[7] = 'Days to Isolation (median)'

t = t[-c(1,7), ]  # take off row that is now the header (1) and days to isolation (7)

kable( t, align = c('r', 'r'), 
       digits = 1, 
       caption = 'Characteristics of EVD cases who were known contacts' )

# test of significance for under 5
d = 
  data %>%
  left_join( key.[, 1:2], by = c('ID' = 'caseID')) %>%
  mutate( knownContact = ifelse(is.na(contactID), 'Not Followed*', 'Followed'), 
          Under5 = ifelse(ages/12<5, 'under5', 'over5') 
          )

t = table(d$Under5, d$knownContact)
f = fisher.test(t)

```

```{r secondarycasescky, fig.cap = 'Histogram of the number of secondary cases associated with source cases.', fig.height= 3}

load('keys.rda')

# There are a few multiple contact-case pairs do to duplicates. 
# all duplicates have same source case.  The following removes the duplicates
# and limits to cases within AugustNovember, and just Conakry

## TODO : figure out how to include cases with multiple case-contact matches.

key. = keys %>% 
  group_by(caseID) %>% filter(row_number(contactID)==1) %>%
  as.data.frame() %>%
  left_join( data , by = c('caseID' = 'ID' )) %>%
  select( caseID, contactID, dateOnset, DistrictRes) %>%
  filter( dateOnset %within% AugustNovember &
            DistrictRes %in% 'Conakry') 

sourceCases = key. %>% 
  inner_join(contacts,  by = c('contactID' = 'ID')) %>%
  select(caseID, SourceCaseID) %>% 
  count(SourceCaseID) %>%
  left_join( data , by = c('SourceCaseID' = 'ID' )) %>% 
  rename(sourceSCRes = SCRes,
         Secondary = n) %>%
  arrange(-Secondary) %>%
  mutate( 
          Outcome = ifelse(StatusReport ==1, 'Died', 'Alive'),
          Hospitalized = ifelse( !is.na(DateIsolationCurrent), 'Y', 'N'),
          Age = floor(ages/12))  %>%
  select( SourceCaseID,
          DistrictRes, sourceSCRes, dateOnset, Gender, 
          Age, HCW, Hospitalized, Outcome, Secondary) 

sourceCases. = sourceCases %>%
  summarise(n = n() ,
            Age = mean(Age, na.rm = TRUE),
            Female = sum( Gender == 2 , na.rm=TRUE) / n, #1-Masculine, 2-Feminine
            Secondary = mean(Secondary)
            )

kable(sourceCases., 
      align = 'r', caption = 'Characteristics of source cases', row.names = FALSE)

# sourceCases[is.na(sourceCases$sourceSCRes), 'sourceSCRes'] = 'Missing'
  

g = sourceCases %>%
ggplot(aes(x=Secondary )) +
  geom_bar(binwidth=1, color='white') +
  scale_y_continuous('Frequency') +
  scale_x_continuous('Number of secondary cases', 
                     breaks = seq(1, max(sourceCases$Secondary), 2)
                     ) 
g

# r=naught
secondary = key. %>% count(caseID) %>% nrow()
sources = sourceCases %>% count(SourceCaseID) %>% nrow()

noSpread = data.cky[data.cky$dateOnset <= max(sourceCases$dateOnset, na.rm = TRUE) ,] %>%
  filter( !(ID %in% sourceCases$SourceCaseID)) %>%
  nrow()

r0max =  secondary  / sources
r0min = secondary  / (sources + noSpread)

# effect of reducing superspreader to only one secondary case
r0prime = (secondary - 13) / sources


```

There were only 15 source cases for the 35 secondary cases identified.  From these, we estimate a reproductive number between `r round(r0max, 1)` and `r round(r0min, 1)`.  The maximum reproductive number was estimated from only those cases with a secondary case (Figure 3); the minimum was estimated when including all cases for whom no secondary cases were identified.

```{r isolationg}

cky.kin = rbind(data.cky, data.kindia)

load('keys.rda')

# There are a few multiple contact-case pairs do to duplicates. 
# all duplicates have same source case.  The following removes the duplicates
# TODO: include all cases--figure out way of deciding which contact goes with the case
key. = keys %>% 
  group_by(caseID) %>% filter(row_number(contactID)==1) %>%
  as.data.frame()

d = 
  data.cky %>%
  left_join( key.[, 1:2], by = c('ID' = 'caseID')) %>%
  mutate( knownContact = ifelse(is.na(contactID), 'Not Followed*', 'Followed'), 
          daysToIso = as.numeric( as.Date(DateIsolationCurrent) - as.Date(DateOnset)),
          daysToIso = ifelse(daysToIso < 1 , NA, daysToIso ),
          iso3 = ifelse(daysToIso <= 3 , 1, 0)
          ) %>%
  select( ID, knownContact, daysToIso, iso3, DateIsolationCurrent, DateOnset, DateReport)

g = ggplot(d, aes( knownContact , daysToIso)) +
#     scale_x_continuous('Month', breaks = c(1:12)) +
    scale_y_continuous('Days to Isolation', breaks = seq(0, 28, 2)) +
    geom_point( position = 'jitter' ) +
#     scale_colour_manual('Status', values = c('grey', "green", "red")) +
    geom_boxplot( aes(group = knownContact) , outlier.shape = NA, fill = NA)  
# g

#Significance

followed = mean(d[ d$knownContact %in% 'Followed', 'daysToIso'], na.rm=TRUE)
not.followed = mean(d[ d$knownContact %in% 'Not Followed*', 'daysToIso'], na.rm=TRUE)

followed.iso3 = mean(d[ d$knownContact %in% 'Followed', 'iso3'], na.rm=TRUE)
not.followed.iso3 = mean(d[ d$knownContact %in% 'Not Followed*', 'iso3'], na.rm=TRUE)

# t.test( daysToIso ~ factor(knownContact), data = data[!is.na(data$daysToIso),])
library("BayesianFirstAid")
# bayes.test = bayes.t.test( daysToIso ~ factor(knownContact), data = d[!is.na(d$daysToIso),])
```

The percentage of patients who were isolated within 3-days of illness onset was greater for those that were known contacts (`r percent(followed.iso3)`) than for those that were not known contacts (`r percent(not.followed.iso3)`).  

# Transmission Chains

The superspreader highlighted in this report accounted for 10 (`r percent(10/31)`) of 31 secondary cases.  Information on the relationships between these cases was missing from the database.  These could be systematically collected, but this requires additional resources and it may be as effective to investigate this cluster after the fact to determine the factors contributing to superspreading.  As there are relatively few superspreaders who contribute to a large number of cases, it would be resource-effective to restrict additional resources to investigation of the superspreading events highlighted through analysis of routine surveillance data.  

```{r superspreaderSecondary}
load('keys.rda')

d = # primary case data
  data.cky %>%
  filter(ID %in% 'GUI-CKY-14-1365') %>%
  select(Gender, ages, DateIsolationCurrent, DateHospitalCurrentAdmit, StatusAsOfCurrentDate, DateDeath, PlaceDeath,
         ContactName1, ContactRelation1, HCW)

load('contacts.rda') # see cky_case_contacts.Rmd
e = contacts %>%
  filter( SourceCaseID %in%  'GUI-CKY-14-1365')

f = e %>%
  left_join( keys , by = c('ID' = 'contactID') ) %>%
  mutate( caseID = as.character(caseID))  

 f. = f %>%
    summarise(  n = n(), 
              Age = sprintf("%s", 
                            format(median(Age, na.rm = TRUE), nsmall = 1) ),
              Under5 = sprintf("%s%%", 
                            format(round( 100*sum(ifelse(Age <5, 1, 0), na.rm = TRUE)/n, 1) ) ),
              Female = sprintf("%s%%", 
                             round(100*sum(Gender %in% "Feminin", na.rm = TRUE)/n, 1) ) , #1-Masculine, 2-Feminine
              HCW = sprintf( '%s%%', 
                             round(sum(HCW %in% "Oui", na.rm = TRUE)/n, 1) ) # 0-no, 1-Yes
             )

kable( f.,   caption = 'Characteristics of Cases Associatied with Case A')
 
# contacts who became case
g = e[, c('ID', 'DateLastContact', 'SourceCaseID')] %>%
  left_join( keys , by = c('ID' = 'contactID') ) %>%
  mutate( caseID = as.character(caseID)) %>% 
  filter( !is.na(caseID) ) %>%
  select(caseID, DateLastContact) %>% unique() %>%
  left_join( data[, c('ID', 'ages', 'dateOnset', 'Gender','HCW', 'SCRes')] , 
            by = c('caseID' = 'ID') ) %>%
  mutate( incubation = as.Date(dateOnset) - as.Date(DateLastContact))

g. = g %>% 
  summarise(
          n = n() ,
          inc = sprintf("%s", 
                            format(mean(incubation, na.rm = TRUE), nsmall = 1) ),
              incmin = sprintf("%s", 
                            format(min(incubation, na.rm = TRUE), nsmall = 1) ),
              incmax = sprintf("%s", 
                            format(max(incubation, na.rm = TRUE), nsmall = 1) )
          )
  

```

Case A, who was the source of infection for 10 confirmed EVD cases was a 40 year old woman whose symptoms included fever and joint pain. According to the case report form, her illness onset, hospitalization, laboratory confirmation of EVD, and death were all on September 2, 2014.  She did not report having contact with a known case and was not a healthcare worker. Case investigators identified 72 persons (Table 4.) who directly touched, ate with, or lived with Case A when she was ill. Of these 12 (`r percent(10/72)`) became confirmed cases from 7 to 21 days after last exposure.  Of these, 7 of had onset close to 3-weeks after last exposure and may signal that there was another (unidentified) case with whom these contacts were exposed.   


```{r igraphChain, fig.cap='Transmission from Case A to ten secondary cases (Case A in black;  secondary female cases in dark grey; secondary male cases in light grey)' }

# igraph

load('keys.rda')


# Case-ContactName should refer to same person as contact's SourceCase
# edges %>% select(caseID,  contactID, ContactName1, SourceCase) %>% filter(!is.na(ContactName1)) %>% arrange(caseID, contactID)

igraphChain = function( .keys = keys, 
                        cases = data, 
                        sourceID = NA ,
                        xaxis = 'incubation',
                        .xlim = c(0, 30),
                        .ylim = c(0, 80),
                        yaxis = 'Age',
                        title = '',
                        edge.var = NA,
                        table = FALSE,
                        curve = .05
                        ){

# select columns that will be used for display
case.cols = c('ID', 'Surname','OtherNames', 'Age', 'Gender' , 'DistrictRes', 'SCRes', 'VillageRes', 
              'DateOnset', 'dateOnset',
              'ContactName1', 'ContactName2')

contact.cols = c('ID', 'DateLastContact', 'SourceCase', 'SourceCaseID', 'HeadHousehold', 'RelationshipToCase')

# edge list
edges = .keys %>% 
  inner_join(cases[, case.cols], by = c('caseID' = 'ID')) %>%  # excludes non-cases
  inner_join(contacts[, contact.cols], by = c('contactID' = 'ID')) %>% 
  mutate( case = caseID , 
          source = SourceCaseID ,
          RelationshipToSource = RelationshipToCase,
          incubation = as.Date(dateOnset) - as.Date(DateLastContact),
          incubation = ifelse(is.na(incubation), 10, incubation) 
          ) %>% 
  filter( !(case == source) ) %>%
  select( source, case , score, incubation, Age, Gender, DistrictRes, SCRes, VillageRes, 
          dateOnset, DateOnset, HeadHousehold, RelationshipToSource) %>%
  unique()  # may have multiple edeges because of duplicate contacts

if (!is.na( sourceID) ){ edges = edges %>% filter(source %in% sourceID) %>% arrange(case, score)}

nodes = unique( c(edges[,1], edges[,2]))
nodes. = data.frame( case = nodes )

# list sources who are not cases
sources =  anti_join( nodes. , edges, by='case') %>% 
  inner_join(cases[, case.cols], by = c('case' = 'ID')) %>%
  select( case , Age, Gender, DistrictRes, SCRes, VillageRes, 
          dateOnset, DateOnset) %>%
  mutate( incubation = 0,
          source = NA,
          score = NA ,
          HeadHousehold = NA,
          RelationshipToSource = NA
          )

node.data = rbind(sources, edges)

# replace missing age with 35
node.data[ is.na(node.data$Age), 'Age'] = 35

library(igraph)
A.vertices = as.matrix(node.data[, c(xaxis, yaxis)])
A =  edges %>% graph.data.frame(directed = TRUE, vertices = nodes)
v.colors = ifelse(node.data$Gender == 1, '#377eb8', '#4daf4a')
v.colors[ node.data$ID %in% sourceID ] = 'black'

library(RColorBrewer)
palette = c('#8dd3c7', '#bebada', '#fb8072', '#80b1d3', 'gray') 
if ( edge.var %in% colnames(edges)){
  e.levels = levels(factor(edges[, edge.var] ))
  e.colors = palette[ match(edges[, edge.var] , e.levels, nomatch = 5)]
} else { e.colors = 'dark grey'}

plot(A, layout = A.vertices, 
              axes = T , main = title,  asp = 0,
              xlim = .xlim, ylim = .ylim, rescale = FALSE, 
              xlab = 'Days from Last Contact with Source Case to Illness Onset', 
              ylab = 'Age (yrs)',
              vertex.label = NA, vertex.size = 100, vertex.label.cex = 0.8,
              vertex.color = v.colors, 
              edge.color = e.colors,
              edge.curved = curve*(-1)^(0:length(edges)) ,
              edge.arrow.size = 0.5)

if (table){ kable(edges, rownames = FALSE)}

}

```

```{r chainA, fig.cap='Transmission from sources to secondary cases.  Position of cases is plotted as the days from last exposure to onset along the x-axis (for clarity, the source cases is placed at 0) and age in years along the y axis. Circles: Blue = Male; Green = Female. Arrows with same color indicates same household'}

# case A
igraphChain(sourceID = 'GUI-CKY-14-1365', title = 'Patient A Transmission', edge.var = 'HeadHousehold')
```

```{r chainb, fig.cap='Transmission from sources to secondary cases.  Position of cases is plotted as the days from last exposure to onset along the x-axis (for clarity, the source cases is placed at 0) and age in years along the y axis. Circles: Blue = Male; Green = Female. Arrows with same color indicates same relationship from source case to secondary case: Blue = nurse'}

# case B 
igraphChain(sourceID = 'GUI-COY-14-0003', title = 'Patient B Transmission', edge.var = 'RelationshipToSource')

```

```{r chainc, fig.cap='Transmission from sources to secondary cases.  Position of cases is plotted as the days from last exposure to onset along the x-axis (for clarity, the source cases is placed at 0) and age in years along the y axis. Reatationship and household data unavailable'}

# case C
igraphChain(sourceID = 'GUI-KER-14-3034', title = 'Patient C Transmission', edge.var = NA)
  
```

# Discussion

# Figures

```{r case_counts}

x = data %>% 
  filter(dateOnset %within% AugustNovember )   %>% 
  count(Region, month) %>% as.data.frame() %>%
  mutate( month = factor(month, levels = c('August', 'September', 'October', 'November'), 
                         order = T),
         Region = ifelse( is.na(Region), 'Unknown', Region) ) 
                

# Region %in% c('Conakry', 'Coyah', "N'Zerekore") &

y = x %>%  spread(month, n)
t = data.frame(Region = 'Total', 
               August = sum(y$August, na.rm=T),
               September = sum(y$September, na.rm=T) , 
               October = sum(y$October, na.rm=T),
               November = sum(y$November, na.rm = T))
y = rbind(y, t)

y[is.na(y)] = 0

# y = rbind(y, data.frame(Region = 'total', data %>% count()) )
kable( comma(y), align = c('l', rep('r', ncol(y)-1)), caption = 'New EVD cases identified in Guinea, August-November, 2014.' )
```

```{r epicurve, fig.cap='Weekly EVD Case Count in Conakry and Kindia, Guinee, August-November, 2014'}

#kindia geography

# data.kindia %>%  count(DistrictRes, ParishRes, SCRes, VillageRes)
  
gtr.cky = data %>% filter(DistrictRes %in% c('Conakry', 'Coyah', 'Forécariah', 'Dubréka') )
cky = data %>% filter(Region %in% c('Conakry') )

# facet by region; fill by prefecture
# SClevels = unique(toupper(cky.kin[order(cky$Region, cky$SCRes), 'SCRes']))

#  cky = cky %>%
#   mutate( 
#     SCRes = factor( toupper(SCRes), levels = SClevels) )
  
cky %>%
  filter(dateOnset %within% AugustNovember ) %>% 
  arrange(dateOnset) %>%
  mutate( interval = week(dateOnset),
          period = as.Date(floor_date(dateOnset, "week")) ) %>%  # set time period
  group_by( DistrictRes, period, ID ) %>%
  summarize( freq = n() ) %>%  
  ggplot( aes(x = period , y = freq, fill = DistrictRes) ) +
  geom_bar( stat = 'identity',fill = 'grey50', color = 'black') +
  scale_x_date('Week', labels = date_format("%b-%d"),
               breaks = date_breaks("week")) +
  scale_fill_brewer('', palette="Set3", guide=FALSE) +
  ylab('Cases') + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1) ) 
# +
# #   scale_fill_manual(values = c('red', 'blue', 'yellow')) +
#   facet_grid( DistrictRes ~ .)

ggsave('caseEpiCurve.png', width = 6.5, height = 3.5, units = 'in')

```

```{r epicurveContacts, fig.cap='Weekly EVD Case Count in Conakry and Kindia, Guinee, August-November, 2014'}

load('contacts.rda') # see cky_case_contacts.Rmd

load('regions.rda')
Region = regions %>%  # table includes Region, DistrictRes, SCRes
  select(-SCRes) %>% # remove SCRes
  unique()

d = contacts %>% 
  merge(Region, all.x = TRUE, by.x= 'District', by.y ='DistrictRes' ) %>%
#   filter(Region %in% c('Conakry', 'Kindia') ) %>%
  filter(DateLastContact %within% AugustNovember ) %>% 
  mutate( 
    interval = week(DateLastContact),
          period = as.Date(floor_date(DateLastContact, "week"))
    )

# d = contacts %>% 
#   merge(Region, all.x = TRUE, by.x= 'District', by.y ='DistrictRes' ) %>%
#   filter(District %in% c('Conakry', 'Coyah', 'Forécariah', 'Dubréka') ) %>%
#   filter(DateLastContact %within% SeptemberOctober ) %>% 
#   mutate( 
#     interval = week(DateLastContact),
#           period = as.Date(floor_date(DateLastContact, "week"))
#     ) 


d %>%
  mutate( place = ifelse(District %in% 'Conakry', 'Conakry', 'Other District') ) %>%
  group_by( place, period , ID) %>%
  summarize( freq = n() ) %>%  
  ggplot( aes(x = period , y = freq, fill = District) ) +
  geom_bar( stat = 'identity',  aes(fill = place)) +
  scale_x_date('Week', labels = date_format("%b-%d"),
               breaks = date_breaks("week")) +
  scale_fill_manual('', values = c('Conakry' = 'blue', 'Other District'= 'brown'), guide=FALSE) +
  ylab('Contacts') + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1) ) +
# #   scale_fill_manual(values = c('red', 'blue', 'yellow')) +
  facet_grid( place ~ .)

ggsave('contactEpiCurve.png', width = 6.5, height = 3.5, units = 'in')

```

```{r caseswerecontacts, fig.height=8, fig.width=6.5, fig.cap='Epicurve of cases and known contacts who became cases (colored boxes), Conakry.'}

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

load('keys.rda')
load('cases.guinea.rda')
load('contacts.guinea.rda')
cases = cases.guinea
contacts = contacts.guinea

# select columns that will be used for display
case.cols = c('ID', 'Surname','OtherNames', 'Age', 'Gender' , 
              'DistrictRes', 'SCRes', 'VillageRes', 
              'DateOnset', 'dateOnset', 'ContactName1', 'ContactName2')

contact.cols = c('ID', 'DateLastContact', 'SourceCase', 'SourceCaseID', 
                 'HeadHousehold', 'RelationshipToCase')

edges = keys %>% 
  inner_join(cases[, case.cols], by = c('caseID' = 'ID')) %>%  # excludes non-cases
  inner_join(contacts[, contact.cols], by = c('contactID' = 'ID')) %>% 
  merge(Region, all.x = TRUE, by ='DistrictRes' ) %>%
  rename( caseRegion = Region,
          caseDistrict = DistrictRes,
          caseSC = SCRes ,
          case = caseID , 
          source = SourceCaseID ,
          RelationshipToSource = RelationshipToCase 
          ) %>% 
  select( source, case , score, Age, Gender, 
          caseDistrict, caseSC, VillageRes, 
          dateOnset, DateOnset, HeadHousehold, RelationshipToSource) %>%
  unique()  # may have multiple edeges because of duplicate contacts
  
# optional, filter to a  source case
# edges = edges %>% filter(source %in% sourceID) %>% arrange(case, score)}

sourceCases = edges %>% 
  select(source) %>% unique() %>% 
  left_join( cases , by = c('source' = 'ID' )) %>%
  merge(Region, all.x = TRUE, by ='DistrictRes' ) %>%
  rename(sourceDistrict = DistrictRes,
         sourceRegion = Region,
         sourceSCRes = SCRes )
#   mutate( sourceSCRes = toupper(sourceSCRes) )%>%
#   select( source, sourceSCRes)  

sourceCases[is.na(sourceCases$sourceSCRes) | 
              sourceCases$sourceSCRes %in% '', 'sourceSCRes'] = 'Unknown'

sourceCases[is.na(sourceCases$sourceDistrict) | 
              sourceCases$sourceDistrict %in% '', 'sourceDistrict'] = 'Unknown'

conakry.districts = c('DIXINN','KALOUM' ,'MATAM', 'MATOTO', 'RATOMA')
notConakry = !( toupper(sourceCases$sourceSCRes) ) %in% conakry.districts
notMissing = !( sourceCases$sourceSCRes %in% 'Unknown')
sourceCases[ notConakry &  notMissing, 'sourceSCRes'] = ' OUTSIDE CONAKRY'

sourceCases %>% count(sourceSCRes)

d = data.cky %>% 
  left_join( edges %>% select(case, source), by = c('ID'= 'case')) %>%
  left_join(sourceCases[, c('source', 'sourceDistrict', 'sourceSCRes', 'sourceRegion')], 
            by = 'source') %>%
  mutate( idnum = substrRight(source, 4),
          period = as.Date(floor_date(dateOnset, "week"))
#           SCRes = ifelse(is.na(SCRes) | SCRes %in% '', 
#                          "Unkown", toupper(SCRes)) , 
#           sourceSCRes = ifelse(is.na(sourceSCRes) | sourceSCRes %in% '', 
#                                " Unkown", toupper(sourceSCRes))
          ) %>% 
  group_by( period, DistrictRes, ID ) %>%
  summarize( freq = 1 ,
             idnum = idnum,
             sourceDistrict = sourceDistrict ,
             sourceRegion = sourceRegion, 
             sourceSCRes = sourceSCRes) %>%
  mutate( cumsum = cumsum(freq),
          midpoint = (cumsum(freq) - 0.5 * freq)) %>%
  arrange(DistrictRes, period, sourceDistrict)

# png('epicurve_secondary_cases.png', height = 7, width = 9.5, units = 'in', res=200)
# g
# dev.off()
```

```{r eppicurveKnownContacts}
data.cky.kin = data %>% filter( Region %in% c('Conakry', 'Kindia') )%>% 
  filter(dateOnset %within% AugustNovember ) 


g1 = 
  d %>% 
  mutate( sourceRegion = ifelse(is.na(sourceRegion), 'Source case unidentified', 
                                ifelse(sourceRegion %in% 'Conakry', 'Conakry', 'Other')
                                ) 
          ) %>% 
  arrange( sourceRegion) %>%
  ## plot
  ggplot( aes(x = period , y = freq) ) +
  geom_bar( stat = 'identity', aes( fill=sourceRegion), color= 'black' ) +
  scale_fill_manual('District of Source Cases:', 
                    values = c('Conakry' = 'grey30',
                               'Other' = 'red',
                               'Source case unidentified' = 'grey90'
                                                   ) 
                    ) + 
#   scale_color_manual('Case from:', values = c('DIXINN' = 'red',
#                                                    'KALOUM' = 'green',
#                                                    'MATOTO' = 'blue',
#                                                    'MATAM' = 'yellow',
#                                                    'RATOMA' = 'purple',
#                                                    'Not reported' = 'grey',
#                                                    ) 
#                      ) + 
#   geom_text( aes(y = midpoint, ymax=midpoint, label = idnum), size = 2, hjust=0.5) +
#   scale_fill_discrete('District of Source Case:') + 
  scale_x_date('Week beginning', labels = date_format("%b-%d"),
               breaks = date_breaks("week")) +
  scale_y_continuous('Cases', labels = comma, breaks = seq(2,24,2) ) + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 2),
       legend.position = 'bottom' ) 
# +
#   facet_grid(DistrictRes ~ .)
g1

ggsave('caseContactEpiCurve.png', g1, width = 10, height = 5.5, units = 'in')
```


```{r percentcaseswerecontacts, fig.height=4, fig.width=6.5, fig.cap='Epicurve of cases and known contacts who became cases (colored boxes), Conakry.'}

g2 = 
   d %>% 
  mutate( known = ifelse(is.na(sourceRegion), 0, 1)) %>% 
  group_by( period ) %>%
  summarize( freq = n() ,
             followed = sum(known) / freq
             ) %>%
  ## plot
  ggplot( aes(x = period , y = followed) ) +
  geom_point( color= 'black', size= 4 ) +
  geom_line() + 
#   geom_text( aes(y = midpoint, ymax=midpoint, label = idnum), size = 2, hjust=0.5) +
  scale_x_date('Week beginning', labels = date_format("%b-%d"),
               breaks = date_breaks("week")) +
  scale_y_continuous('% Cases', labels = percent, breaks = seq(0,1,.25), limits = c(0,1)) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 2),
       legend.position = 'top' ) 
g2

ggsave('percentFollowed.png', g2, width = 10, height = 4.5, units = 'in')
```

```{r eppicurveKnownContactsSC, eval=FALSE}
d = 
  data.cky %>% 
  left_join( edges %>% select(case, source), by = c('ID'= 'case')) %>%
  left_join(sourceCases[, c('source', 'sourceDistrict', 'sourceSCRes', 'sourceRegion')], 
            by = 'source') %>%
  mutate( idnum = substrRight(source, 4),
          period = as.Date(floor_date(dateOnset, "week")),
          SCRes = toupper(SCRes),
          sourceRegion = ifelse(is.na(sourceRegion), 'Source case unidentified', 
                                ifelse(sourceRegion %in% 'Conakry', 'Conakry', 'Other')
          ) ) %>% 
  group_by( period, DistrictRes, SCRes, ID ) %>%
  summarize( freq = 1 ,
             idnum = idnum,
             sourceDistrict = sourceDistrict ,
             sourceRegion = sourceRegion, 
             sourceSCRes = sourceSCRes) %>%
  mutate( cumsum = cumsum(freq),
          midpoint = (cumsum(freq) - 0.5 * freq),
          sourceSCRes = toupper(sourceSCRes)) %>%
  arrange(DistrictRes, SCRes, period, sourceDistrict, sourceSCRes) 

d %>% group_by(SCRes, sourceRegion) %>% summarise( n = n())

g = d %>%
  ## plot
  ggplot( aes(x = period , y = freq) ) +
  geom_bar( stat = 'identity', aes( fill=sourceSCRes), color= 'black' ) +
  scale_fill_manual('District of Source Cases:', values = c('DIXINN' = 'red',
                                                   'KALOUM' = 'green',
                                                   'MATOTO' = 'blue',
                                                   'MATAM' = 'yellow',
                                                   'RATOMA' = 'purple',
                                                   'UNKNOWN' = 'black',
                                                   ' OUTSIDE CONAKRY' = 'orange',
                                                   ' Not a Known Contact' = 'white'
                                                   ) 
                    ) + 
#   scale_color_manual('Case from:', values = c('DIXINN' = 'red',
#                                                    'KALOUM' = 'green',
#                                                    'MATOTO' = 'blue',
#                                                    'MATAM' = 'yellow',
#                                                    'RATOMA' = 'purple',
#                                                    'Not reported' = 'grey'
#                                                    ) 
#                      ) + 
#   geom_text( aes(y = midpoint, ymax=midpoint, label = idnum), size = 2, hjust=0.5) +
  scale_x_date('Week beginning', labels = date_format("%b-%d"),
               breaks = date_breaks("week")) +
  scale_y_continuous('Cases', labels = comma, breaks = seq(2,24,2) ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 2),
       legend.position = 'right' ) +
  facet_grid(SCRes ~ .)
g
```

```{r epicurvecaseswerecontacts_Kin, fig.height=8, fig.width=6.5, fig.cap='Epicurve of cases and known contacts who became cases (colored boxes), Kindia.', eval=FALSE}

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
} 

load('kin.keys.rda')
keys = kin.keys

# select one key pair for each case; one pair for each contact
key. = keys %>% 
  group_by(case) %>% filter(row_number(contact)==1) %>%
  group_by(contact) %>% filter(row_number(case)==1) %>% as.data.frame()

sourceCases = key. %>% select(SourceCaseID) %>%
  left_join( data , by = c('SourceCaseID' = 'ID' )) %>%
  merge(Region, all.x = TRUE, by.x= 'District', by.y ='DistrictRes' ) %>%
  rename(sourceSCRes = SCRes) %>%
  select( SourceCaseID, sourceSCRes) %>% unique() 

sourceCases[is.na(sourceCases$sourceSCRes) | 
              sourceCases$sourceSCRes %in% '', 'sourceSCRes'] = 'Missing'
conakry.districts = c('DIXINN','KALOUM' ,'MATAM', 'MATOTO', 'RATOMA')
notConakry = !( toupper(sourceCases$sourceSCRes) ) %in% conakry.districts
notMissing = !( sourceCases$sourceSCRes %in% 'Location missing')
sourceCases[ notConakry &  notMissing, 'sourceSCRes'] = 'Other'

g = 
  data.kindia %>% 
  left_join( key. %>% select(case, SourceCaseID), by = c('ID'= 'case')) %>%
  left_join(sourceCases) %>%
  mutate( idnum = substrRight(SourceCaseID, 4),
          period = as.Date(floor_date(dateOnset, "week")),
          SCRes = ifelse(is.na(SCRes) | SCRes %in% '', 
                         "LOCATION NOT REPORTED", toupper(SCRes)) , 
          sourceSCRes = ifelse(is.na(sourceSCRes) | sourceSCRes %in% '', 
                               "Not a Known Contact", toupper(sourceSCRes))
          ) %>% 
  group_by( period, SCRes, ID ) %>%
  summarize( freq = n() ,
             idnum = idnum,
             sourceSCRes = sourceSCRes) %>%
  mutate( cumsum = cumsum(freq),
          midpoint = (cumsum(freq) - 0.5 * freq)) %>%
  ## plot
  ggplot( aes(x = period , y = freq) ) +
  geom_bar( stat = 'identity', aes( fill=sourceSCRes), color= 'black' ) +
  scale_fill_manual('Source Case from:', values = c('DIXINN' = 'red',
                                                   'KALOUM' = 'green',
                                                   'MATOTO' = 'blue',
                                                   'MATAM' = 'yellow',
                                                   'RATOMA' = 'purple',
                                                   'LOCATION NOT REPORTED' = 'black',
                                                   'OTHER' = 'orange',
                                                   'Not a Known Contact' = 'white'
                                                   ) 
                    ) + 
#   geom_text( aes(y = midpoint, ymax=midpoint, label = idnum), size = 2, hjust=0.5) +
  scale_x_date('Week beginning', labels = date_format("%b-%d"),
               breaks = date_breaks("week")) +
  scale_y_continuous('Cases', labels = comma, breaks = seq(2,26, by=2) ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 2),
       legend.position = 'right' ) 
g

# png('epicurve_secondary_cases.png', height = 7, width = 9.5, units = 'in', res=200)
# g
# dev.off()
```


```{r gadm_map_data}

# Get GADM rdata files

# see
# http://stackoverflow.com/questions/5126745/gadm-maps-cross-country-comparision-graphics

## load a file from GADM (you just have to specify the countries "special part" of the file name, like "ARG" for Argentina. Optionally you can specify which level you want to have
loadGADM <- function (fileName, level = 1, ...) {
  # load files downloaded from gadm
  load(paste(fileName, "_adm", level, ".RData", sep     = ""))
  gadm
}

## the maps objects get a prefix (like "ARG_" for Argentina)
changeGADMPrefix = function (GADM, prefix) {
  GADM <- spChFIDs(GADM, paste(prefix, row.names(GADM), sep = "_"))
  GADM
}

## load file and change prefix
loadChangePrefix = function (fileName, level = 0, ...) {
  theFile <- loadGADM(fileName, level)
  theFile <- changeGADMPrefix(theFile, fileName)
  theFile
}

## this function creates a SpatialPolygonsDataFrame that contains all maps you specify in "fileNames".
## E.g.: 
## spdf <- getCountries(c("ARG","BOL","CHL"))
## plot(spdf) # should draw a map with Brasil, Argentina and Chile on it.

getCountries = function (fileNames, level = 0, ...) {
  polygon <- sapply(fileNames, loadChangePrefix, level)
  polyMap <- do.call("rbind", polygon)
  polyMap
}


tolerance = .01

country = "LBR"

     gadm.lib = getCountries(country, level=0)
     gadm.lib.f = as.data.frame(gadm.lib) 
    liberia = gadm.lib %>%
#             gSimplify(tolerance, topologyPreserve=T) %>%
            fortify(region = "ID_0") %>%
            mutate( id = as.integer(id)) %>%
            reshape::rename(c("id" = "ID_0")) %>%  #explicit call to rename function in reshape package (as opposed to rename function in plyr package)
            left_join(
              gadm.lib.f[, c("ID_0", "NAME_ENGLISH")])

  liberia.c =  gadm.lib %>% coordinates()  %>% as.data.frame() 
  liberia.c$NAME = 'Liberia'

country = "SLE"

     gadm.sle = getCountries(country, level=0)
     gadm.sle.f = as.data.frame(gadm.sle) 
    sierra = gadm.sle %>%
#             gSimplify(tolerance, topologyPreserve=T) %>%
            fortify(region = "ID_0") %>%
            mutate( id = as.integer(id)) %>%
            reshape::rename(c("id" = "ID_0")) %>%  #explicit call to rename function in reshape package (as opposed to rename function in plyr package)
            left_join(
              gadm.sle.f[, c("ID_0", "NAME_ENGLISH")])
  sierra.c =  gadm.sle %>% coordinates()  %>% as.data.frame() 
  sierra.c$NAME = 'Sierra Leone'


country = "GIN"

     gadm = getCountries(country, level=3)
     gadm.f = as.data.frame(gadm) 

    # make list of regions, prefectures, sous prefectures
    regions = gadm.f %>% select(NAME_1,NAME_2,NAME_3) 
    colnames(regions) = c('Region', 'DistrictRes', 'SCRes')

     # fix name of capital in GADM file!
     regions[regions$DistrictRes == 'Conarky', 'DistrictRes'] = 'Conakry'
     regions[regions$Region == 'Conarky', 'Region'] = 'Conakry'
      
    regions[regions$DistrictRes == 'Yamou', 'DistrictRes'] = 'Yomou'

save(regions, file = 'regions.rda')
     
     GIN3 = gadm %>%
#             gSimplify(tolerance, topologyPreserve=T) %>%
            fortify(region = "ID_3") %>%
            mutate( id = as.integer(id)) %>%
            reshape::rename(c("id" = "ID_3")) %>%  #explicit call to rename function in reshape package (as opposed to rename function in plyr package)
            left_join(
              gadm.f[, c("ID_3", "NAME_1", "NAME_2", "NAME_3")])

# fix name of capital in GADM file!
GIN3[GIN3$NAME_2 == 'Conarky', 'NAME_2'] = 'Conakry'
GIN3[GIN3$NAME_2 == 'Yamou', 'NAME_2'] = 'Yomou'


# get location and names for labels
# Admin 3 labels 

          Names = gadm.f %>% 
               select( which(colnames(gadm.f) =="NAME_3"),
                       which(colnames(gadm.f) == "TYPE_3")
               )

          
          GIN3.c =  gadm %>%
                       coordinates()  %>%
                       as.data.frame() %>%
                       mutate(Name = Names[,'NAME_3'],
                              Type = Names[,'TYPE_3']
                              )
# fix name of capital in GADM file!
GIN3.c[GIN3.c$Name == 'Conarky', 'Name'] = 'Conakry'
GIN3.c[GIN3.c$Name == 'Yamou', 'Name'] = 'Yomou'

# Admin 2

     gadm = getCountries(country, level=2)
     gadm.f = as.data.frame(gadm) 

     GIN2 = gadm %>%
#             gSimplify(tolerance, topologyPreserve=T) %>%
            fortify(region = "ID_2") %>%
            mutate( id = as.integer(id)) %>%
            reshape::rename(c("id" = "ID_2")) %>%
            left_join(
              gadm.f[, c("ID_2", "NAME_1", "NAME_2")])

# fix name of capital in GADM file!
GIN2[GIN2$NAME_2 == 'Conarky', 'NAME_2'] = 'Conakry'
GIN2[GIN2$NAME_2 == 'Yamou', 'NAME_2'] = 'Yomou'

# Admin 2 labels

          Names = gadm.f %>% 
               select( which(colnames(gadm.f) =="NAME_2"),
                       which(colnames(gadm.f) == "TYPE_2")
               )
 
          GIN2.c =  gadm %>%
                       coordinates()  %>%
                       as.data.frame() %>%
                       mutate(Name = Names[,'NAME_2'],
                              Type = Names[,'TYPE_2']
                              ) 

# fix name of capital in GADM file!
GIN2.c[GIN2.c$Name == 'Conarky', 'Name'] = 'Conakry'
GIN2.c[GIN2.c$Name == 'Yamou', 'Name'] = 'Yomou'

```

```{r gadmNames, eval=FALSE}
gin.names = unique( GIN3[, c('NAME_1', 'NAME_2', 'NAME_3') ])
write.csv(gin.names, file='GuineaNames.csv', row.names=FALSE, fileEncoding = 'UTF-8')

```

```{r theme_defaults}
theme_bare = theme(line = element_blank(),
                   text = element_blank(),
                   line = element_blank(),
                   title = element_blank())

# aesthetic defaults...
color.brewer = "BuPu"  # "YlGnBu" , 'PuBu'  'Greys' (http://colorbrewer2.org/)
zero.color = 'white' # add color for cells with zero counts
background.color = 'grey99' 
county.border.color = 'grey70' 
state.border.color = 'grey45'
legend.placement = c(.5, -.05)  
legend.font.size = 11 

theme_map =  # coord_map() +
     theme(
          legend.position = legend.placement,
          legend.direction = 'horizontal',
          legend.background = element_blank(),
          legend.title=element_text(size=legend.font.size),
          legend.text = element_text(size=legend.font.size),
          panel.grid.major=element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.ticks = element_blank(),
          axis.text = element_blank(),
          panel.border = element_blank(),
          strip.background = element_rect(colour=background.color, 
                                          fill=background.color),
          panel.background = element_rect(fill=background.color),
          plot.margin = unit(c(0,0,2,0),"cm") # remove plot margins
     )
```

```{r tab_district, results='asis'}

load('regions.rda')
Region = regions %>%  # table includes Region, DistrictRes, SCRes
  select(-SCRes) %>% # remove SCRes
  unique()

# Add indicator for counting cases
load('cases.guinea.rda')
cases.guinea$case = 1

d = cases.guinea %>% 
  filter(dateOnset < as.Date(ymd('2014-DEC-01')) ) %>%
  mutate( DistrictRes = ifelse( DistrictRes %in% '', NA, DistrictRes)) %>%
  merge(Region, all = TRUE, by= 'DistrictRes') 

d.augnov = cases.guinea %>% 
  filter(dateOnset %within% AugustNovember ) %>%
  mutate( DistrictRes = ifelse( DistrictRes %in% '', NA, DistrictRes)) %>%
  merge(Region, all = TRUE, by= 'DistrictRes') 
  
d.previous = cases.guinea %>% 
  filter(dateOnset < as.Date(ymd('2014-AUG-01')) ) %>%
  merge(Region, all = TRUE, by= 'DistrictRes')

p.total = d %>%
  group_by(DistrictRes) %>% 
  summarize(Total = sum( case, na.rm = TRUE)) 

p.augnov = d.augnov %>%  # tabulate totals by location
  group_by(DistrictRes ) %>% 
  summarize( AugNov = sum( case, na.rm = TRUE)) 

p.previous = d.previous %>%  # tabulate totals by location
  group_by(DistrictRes ) %>% 
  summarize( previous = sum( case, na.rm = TRUE)) 

# p.previous = rbind(p.previous, data.frame(DistrictRes = NA, previous=NA))
# p.previous[is.na(p.total[,1]), 1 ] <- 'Unknown'


p = cbind(p.augnov, p.previous[,2], p.total[,2]) # join TOTALS to t

p[is.na(p[,1]), 1 ] <- 'Unknown'

p[is.na(p)] <- 0  # convert NA to 0

# kable(p)  # print table

```

```{r prefets_dot, fig.cap="Cas d'Ebola pendant le dernier 21 jours, Guinee", fig.height=8, fig.width=6.5}

# classify values
p$AugNov =  cut(p$AugNov, 
                      breaks = c(1, 25, 50, 100, 200, 400, Inf), 
                      label = c('1-25','25-49','50-99','100-199','200-399', '400 +'),
#                       breaks = c(0,1, 10, 20, 50, 100, Inf), 
#                       label = c('0','1-9','10-19','20-50','50-100', '100 +'),
                      right=FALSE, include.lowest=TRUE)


# classify totals 
p$previous =  cut( p$previous, 
                      breaks = c(0, 1, 25, 50, 100, 200, 400, Inf), 
                      label = c('0','1-25','25-49','50-99','100-199','200-399', '400 +'),
#                       breaks = c(0, 1, 10, 20, 50, 100, Inf), 
#                       label = c('0','1-9','10-19','20-50','50-100', '100 +'),
                      right=FALSE, include.lowest=TRUE)

# Join data with map
p$NAME_2 = p$DistrictRes
map.data.p = merge(GIN2, p, all.x=TRUE, 
                 by.y='NAME_2', by.x = 'NAME_2') %>%
  merge(GIN2.c, all.x = TRUE) %>%
  arrange(order) 

map.data.p.c = merge(GIN2.c, p, all.x=TRUE, by.y='NAME_2', by.x = 'Name') 

color.brewer ="YlOrBr" # "Purples" # 
colors = brewer.pal(7, color.brewer)  # fill colors

g = ggplot( ) + theme_map +
  coord_map() +
  geom_polygon(data= map.data.p,
               aes(x=long, y=lat, group=group, 
                   fill=previous), 
               color="grey50", alpha=1) + 
  geom_text(data= GIN2.c, aes(label = Name, x=V1, y=V2), size=3, vjust = 1.5) +
  scale_fill_manual('Cases through August, 2014', values = colors, drop = FALSE) +
  geom_point(data= map.data.p.c, aes(x=V1, y=V2, size = AugNov), 
             color = "black") + 
  scale_size_discrete("Cases During August-November, 2014") +
  scale_alpha_discrete("Cases During August-November, 2014") +
  geom_polygon(data= liberia,
               aes(x=long, y=lat, group=group), 
               color="grey50", fill = NA) +
  geom_text(data= liberia.c, aes(label = NAME, x=V1, y=V2), size=4, vjust = 1.5) +
  geom_polygon(data= sierra,
               aes(x=long, y=lat, group=group), 
               color="grey50", fill = NA) +
  geom_text(data= sierra.c, aes(label = NAME, x=V1, y=V2), size=4, vjust = 1.5) +
  labs(x=NULL, y=NULL)
g

# ggsave(plot = g, 'AugNov.png', width=6.5, height=6.5, units='in')
```

