---
title: Ebola Virus Disease Contact Reporting and Outbreak Response Monitoring, Conakry,
  Guinea, September-October, 2014
author: John Painter (Corresponding author), Benjamin Dahl, Fatima Coronado, Mathieu
  Bangerts, Michael Martin, Guenael Rodier, William Perera, Boubacar Diallo, (Stephan
  - MSF) (WHO DB admins), Jon E. Tongren
date: "Friday, October 24, 2014"
output:
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 6.5
  pdf_document:
    fig_caption: yes
    keep_tex: yes
---

\openup 1em  

```{r setup, echo=FALSE, results='hide', message=FALSE, warning=FALSE }
# options(tz="GMT+0")
# Sys.setenv(TZ='GMT+0')

library(knitr)
opts_chunk$set( echo=FALSE, message=FALSE, comment="", 
                warning = FALSE, results='asis', 
                fig.width = 6.5, fig.height = 4,
                cache = FALSE)

library(XLConnect, quietly=TRUE)
library(lubridate)
library(reshape)  # use for rename() function

library(rgeos)
library(sp)

suppressPackageStartupMessages(library(ggplot2))
library(scales)
library(grid)
library(RColorBrewer)

# library(devtools)
# devtools::install_github("hadley/tidyr")
library(tidyr) # install from github (CRAN version not working...)
library(dplyr, quietly=TRUE) # order is important...

```


```{r data, echo=FALSE, message=FALSE}

# cleaned data from 'dashboard.R'
# for updated data, run: 
# source('dashboard.R')
# load('case_guinea_sl.rda')  

### Warning: this data is missing recordxs....

#....so use same VHF data used to find cases-contacts
load('cases.guinea.rda')

SeptemberOctober = new_interval(ymd('2014-SEP-01'), ymd('2014-OCT-31') )

load('regions.rda')
Region = regions %>%  # table includes Region, DistrictRes, SCRes
  select(-SCRes) %>% # remove SCRes
  unique()

data = cases.guinea %>% 
  merge(Region, all.x = TRUE, by= 'DistrictRes') %>%
  mutate( 
    month = months(dateOnset),
    daysToIso = as.numeric( as.Date(DateIsolationCurrent) - as.Date(DateOnset) ),
    ages = ifelse( AgeUnit %in% 'Ans', Age*12, Age)
    ) 

data.cky = data %>% filter( Region %in% 'Conakry') %>% 
  filter(dateOnset %within% SeptemberOctober ) 

data.kindia = data %>% filter( Region %in% 'Kindia') %>%
  filter(dateOnset %within% SeptemberOctober )

data.forrest = data %>% filter( Region %in% 'Nzérékoré') %>% 
  filter(dateOnset %within% SeptemberOctober )  


# contacts...
load('contacts.guinea.rda') # see cky_case_contacts.Rmd

load('regions.rda')
Region = regions %>%  # table includes Region, DistrictRes, SCRes
  select(-SCRes) %>% # remove SCRes
  unique()

contact.cky  = contacts.guinea %>% 
  merge(Region, all.x = TRUE, by.x= 'District', by.y ='DistrictRes' ) %>%
  filter(Region %in% c('Conakry', 'Kindia') )

#  contact.cky %>%  count(District)

```

In Guinea, the number of newly identified Ebola virus disease (EVD) increased during September-October, 2014 compared with previous months. There were `r data %>% count()` new cases of EVD in Guinea (Table 1, Figure 1). As in previous months, most new cases were identified in the forest region (Guéckédou, Macenta, Nzérékoré, and Beyla districts).  In Conakry, the capital, which is approximately 450 miles from the forrest region, there were `r data.cky %>% count()` new cases, which was much greater than the number of cases previosuly identified in Conakry, suggesting the possibility of uncontrolled transmission in an urban area.  Urban transmission has been a primary factor in the large numbers of EVD cases in the neighboring countries, Liberia and Sierra Leone.^[Recent MMWR report...] Additionally, there were `r data.kindia %>% count()` new cases in Kindia, the district adjacent to Conakry.  Interviews of EVD cases identified potentially exposed persons (contacts) who were followed by local public health officials.  Matching person identifiable information from case and contact registrys, we identified 30 (`r percent(30/nrow(data.cky))`) cases that were known contacts of cases.  Monitoring these secondary cases may be a useful measure for assessing the completeness and effectiveness of contact investigations. 

# EVD in Conakry and Adacent Districts

Prior to the opening of a third Ebola treatment center (ETC) in Macenta, all Ebola patients in Guinea were treated at the Medecin Sans Frontiers (MSF) ETC in Conakry or Guéckédou.  This report summarizes patient identificatio and contact tracing activity conducted in Conakry.   

## Patient Identification
 
When Ebola symptoms are identified in a person, a public health alert is triggered to provide effective patient care, stop disease transmission, and offer community education. To receive health care, suspect patient from Conakry and surrounding districts were transported to the Donka ETC^[http://www.msf.org/article/guinea-donka-ebola-treatment-centre-conakry-stretched-limit] and placed in isolation. Specimens were taken for laboratory confirmation, with the results usually being available within 24 hours. Affected persons were hospitalized until their laboratory specimens were negative.  During this period, Donka hospital was able to admit all suspected and confirmed EVD patients for isolationa and treatment.

## Contact Tracing

To stop disease transmission, information regarding contacts was obtained by for all identified Ebola patients. For hospitalized patients, this information was collected by Donka ETC staff.  The Guinean MoH is responsible for the contact tracing throughout the country. CDC and WHO provide provide training and support.  Community agents visit identified contacts daily for fever and symptom checks for 21 days after last exposure to a EVD case.  Community agent supervisors spot check with random visits to contact families, fill in and report the contact tracing forms daily, and have biweekly meetings to respond to challenges.Contacts were systematically monitored for symptoms for 21 days (i.e., wellness checks and temperature monitoring daily); any contact demonstrating Ebola symptoms was placed in isolation, tested for the virus, and asked about their contacts. If a contact did not have any symptoms after 21 days, the contact was considered no longer monitored. Contact tracing teams and field supervisors were responsible for the prompt and full implementation of contact tracing activities, and the contact tracing process repeated with each newly identified patient until no new cases occur. Contact tracing information was sent to WHO/MoH to update information in a national database.  The number of contacts reported to the national VHF database with date of last exposure in Sepember and October, 2014 was 2,990 for Conakry and only 51 for Kindia. (Figure 2.)


```{r epicurveContacts, fig.cap='Weekly EVD Case Count in Conakry and Kindia, Guinee, September-October, 2014'}

load('contacts.rda') # see cky_case_contacts.Rmd
  
SeptemberOctober = new_interval(ymd('2014-SEP-01'), ymd('2014-OCT-31') )

load('regions.rda')
Region = regions %>%  # table includes Region, DistrictRes, SCRes
  select(-SCRes) %>% # remove SCRes
  unique()

d = contacts %>% 
  merge(Region, all.x = TRUE, by.x= 'District', by.y ='DistrictRes' ) %>%
  filter(Region %in% c('Conakry', 'Kindia') ) %>%
  filter(DateLastContact %within% SeptemberOctober ) %>% 
  mutate( 
    interval = week(DateLastContact),
          period = as.Date(floor_date(DateLastContact, "week"))
    ) 
  
d %>%
  arrange(DateLastContact) %>%
  group_by( Region, period ) %>%
  summarize( freq = n() ) %>%  
  ggplot( aes(x = period , y = freq, fill = Region) ) +
  geom_bar( stat = 'identity', color = 'white') +
  scale_x_date('Week', labels = date_format("%b-%d"),
               breaks = date_breaks("week")) +
  scale_fill_brewer('', palette="Set3", guide=FALSE) +
  ylab('Contacts') + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1) ) +
#   scale_fill_manual(values = c('red', 'blue', 'yellow')) +
  facet_grid( Region ~ .)


```

## Patient and Contact Information Flow

A case notifications form, including demographic, clinical, epidemiologic, and laboratory information, was completed at the Donka ETC for all patients, including suspect, probable and laboratory-confirmed. Data collected on the form are entered into an Excel® (Microsoft Corp., Redmond, Washington) spreadsheet by the ETC staff and sent every evening to the World Health Organization (WHO) and Guinean Ministry of Health (MoH). Data sent from the two Guinean ETCs (i.e., Conakry and Guéckedou) were entered into the Epi Info™ (CDC, Atlanta, Georgia) viral hemorrhagic fever (VHF) national database and analyzed daily. To update case-reports when new laboratory results or patient status (e.g. died, or discharged) became available, MSF sent an updated spreadsheet by e-mail to WHO/MoH.

## New Cases that were known contacts. 

To identify cases who were known contacts, we linked records for cases and contacts entered into the national VHF database.  Linkage was performed by cross-checking first and last name, age, and addresses (region, district, sub-district, and village). Names were matched using a probabalistic algorithm that ranked matches according to the number of chracter or digits that would need to be changed in order to create an exact match.  We considered a difference of 3 or less characters in names and locations, and 1 or less character in the age, as a potential match.  Potential matches with illness onset before the contact's reported exposure were excluded.  



```{r epicurvecaseswerecontacts, fig.height=8, fig.width=6.5, fig.cap='Epicurve of cases and known contacts who became cases (colored boxes), Conakry.'}

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

load('keys.rda')
load('cases.guinea.rda')
load('contacts.guinea.rda')
cases = cases.guinea
contacts = contacts.guinea

# select columns that will be used for display
case.cols = c('ID', 'Surname','OtherNames', 'Age', 'Gender' , 
              'DistrictRes', 'SCRes', 'VillageRes', 
              'DateOnset', 'dateOnset', 'ContactName1', 'ContactName2')

contact.cols = c('ID', 'DateLastContact', 'SourceCase', 'SourceCaseID', 
                 'HeadHousehold', 'RelationshipToCase')

edges = keys %>% 
  inner_join(cases[, case.cols], by = c('caseID' = 'ID')) %>%  # excludes non-cases
  inner_join(contacts[, contact.cols], by = c('contactID' = 'ID')) %>% 
  merge(Region, all.x = TRUE, by ='DistrictRes' ) %>%
  rename( caseRegion = Region,
          caseDistrict = DistrictRes,
          caseSC = SCRes ,
          case = caseID , 
          source = SourceCaseID ,
          RelationshipToSource = RelationshipToCase 
          ) %>% 
  select( source, case , score, Age, Gender, 
          caseDistrict, caseSC, VillageRes, 
          dateOnset, DateOnset, HeadHousehold, RelationshipToSource) %>%
  unique()  # may have multiple edeges because of duplicate contacts
  
# optional, filter to a  source case
# edges = edges %>% filter(source %in% sourceID) %>% arrange(case, score)}

sourceCases = edges %>% 
  select(source) %>% unique() %>% 
  left_join( cases , by = c('source' = 'ID' )) %>%
  merge(Region, all.x = TRUE, by ='DistrictRes' ) %>%
  rename(sourceDistrict = DistrictRes,
         sourceRegion = Region,
         sourceSCRes = SCRes )
#   mutate( sourceSCRes = toupper(sourceSCRes) )%>%
#   select( source, sourceSCRes)  

sourceCases[is.na(sourceCases$sourceSCRes) | 
              sourceCases$sourceSCRes %in% '', 'sourceSCRes'] = 'Unknown'

sourceCases[is.na(sourceCases$sourceDistrict) | 
              sourceCases$sourceDistrict %in% '', 'sourceDistrict'] = 'Unknown'

conakry.districts = c('DIXINN','KALOUM' ,'MATAM', 'MATOTO', 'RATOMA')
notConakry = !( toupper(sourceCases$sourceSCRes) ) %in% conakry.districts
notMissing = !( sourceCases$sourceSCRes %in% 'Unknown')
sourceCases[ notConakry &  notMissing, 'sourceSCRes'] = ' OUTSIDE CONAKRY'

sourceCases %>% count(sourceSCRes)

d = data.cky %>% 
  left_join( edges %>% select(case, source), by = c('ID'= 'case')) %>%
  left_join(sourceCases[, c('source', 'sourceDistrict', 'sourceSCRes', 'sourceRegion')], 
            by = 'source') %>%
  mutate( idnum = substrRight(source, 4),
          period = as.Date(floor_date(dateOnset, "week"))
#           SCRes = ifelse(is.na(SCRes) | SCRes %in% '', 
#                          "Unkown", toupper(SCRes)) , 
#           sourceSCRes = ifelse(is.na(sourceSCRes) | sourceSCRes %in% '', 
#                                " Unkown", toupper(sourceSCRes))
          ) %>% 
  group_by( period, DistrictRes, ID ) %>%
  summarize( freq = 1 ,
             idnum = idnum,
             sourceDistrict = sourceDistrict ,
             sourceRegion = sourceRegion, 
             sourceSCRes = sourceSCRes) %>%
  mutate( cumsum = cumsum(freq),
          midpoint = (cumsum(freq) - 0.5 * freq)) %>%
  arrange(DistrictRes, period, sourceDistrict)

# png('epicurve_secondary_cases.png', height = 7, width = 9.5, units = 'in', res=200)
# g
# dev.off()
```

```{r eppicurveKnownContactsDistrict}
data.cky.kin = data %>% filter( Region %in% c('Conakry', 'Kindia') )%>% 
  filter(dateOnset %within% SeptemberOctober ) 


g = 
  data.cky %>% 
  left_join( edges %>% select(case, source), by = c('ID'= 'case')) %>%
  left_join(sourceCases[, c('source', 'sourceDistrict', 'sourceSCRes', 'sourceRegion')], 
            by = 'source') %>%
  mutate( idnum = substrRight(source, 4),
          period = as.Date(floor_date(dateOnset, "week"))
#           SCRes = ifelse(is.na(SCRes) | SCRes %in% '', 
#                          "Unkown", toupper(SCRes)) , 
#           sourceSCRes = ifelse(is.na(sourceSCRes) | sourceSCRes %in% '', 
#                                " Unkown", toupper(sourceSCRes))
          ) %>% 
  group_by( period, DistrictRes, ID ) %>%
  summarize( freq = 1 ,
             idnum = idnum,
             sourceDistrict = sourceDistrict ,
             sourceRegion = sourceRegion, 
             sourceSCRes = sourceSCRes) %>%
  mutate( cumsum = cumsum(freq),
          midpoint = (cumsum(freq) - 0.5 * freq)) %>%
  arrange(DistrictRes, period, sourceDistrict) %>%
  ## plot
  ggplot( aes(x = period , y = freq) ) +
  geom_bar( stat = 'identity', aes( fill=sourceDistrict), color= 'black' ) +
#   scale_fill_manual('District of Source Cases:', values = c('DIXINN' = 'red',
#                                                    'KALOUM' = 'green',
#                                                    'MATOTO' = 'blue',
#                                                    'MATAM' = 'yellow',
#                                                    'RATOMA' = 'purple',
#                                                    'Unknown' = 'black',
#                                                    ' Outside of Conakry ' = 'orange',
#                                                    ' Not a Known Contact' = 'white'
#                                                    ) 
#                     ) + 
#   scale_color_manual('Case from:', values = c('DIXINN' = 'red',
#                                                    'KALOUM' = 'green',
#                                                    'MATOTO' = 'blue',
#                                                    'MATAM' = 'yellow',
#                                                    'RATOMA' = 'purple',
#                                                    'Not reported' = 'grey'
#                                                    ) 
#                      ) + 
#   geom_text( aes(y = midpoint, ymax=midpoint, label = idnum), size = 2, hjust=0.5) +
  scale_x_date('Week beginning', labels = date_format("%b-%d"),
               breaks = date_breaks("week")) +
  scale_y_continuous('Cases', labels = comma, breaks = seq(2,24,2) ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 2),
       legend.position = 'right' ) +
  facet_grid(DistrictRes ~ .)
g
```


```{r eppicurveKnownContactsSC}
g = 
  data.cky %>% 
  left_join( edges %>% select(case, source), by = c('ID'= 'case')) %>%
  left_join(sourceCases[, c('source', 'sourceDistrict', 'sourceSCRes', 'sourceRegion')], 
            by = 'source') %>%
  mutate( idnum = substrRight(source, 4),
          period = as.Date(floor_date(dateOnset, "week")),
          SCRes = toupper(SCRes)
          ) %>% 
  group_by( period, DistrictRes, SCRes, ID ) %>%
  summarize( freq = 1 ,
             idnum = idnum,
             sourceDistrict = sourceDistrict ,
             sourceRegion = sourceRegion, 
             sourceSCRes = sourceSCRes) %>%
  mutate( cumsum = cumsum(freq),
          midpoint = (cumsum(freq) - 0.5 * freq),
          sourceSCRes = toupper(sourceSCRes)) %>%
  arrange(DistrictRes, SCRes, period, sourceDistrict, sourceSCRes) %>%
  ## plot
  ggplot( aes(x = period , y = freq) ) +
  geom_bar( stat = 'identity', aes( fill=sourceSCRes), color= 'black' ) +
  scale_fill_manual('District of Source Cases:', values = c('DIXINN' = 'red',
                                                   'KALOUM' = 'green',
                                                   'MATOTO' = 'blue',
                                                   'MATAM' = 'yellow',
                                                   'RATOMA' = 'purple',
                                                   'UNKNOWN' = 'black',
                                                   ' OUTSIDE CONAKRY' = 'orange',
                                                   ' Not a Known Contact' = 'white'
                                                   ) 
                    ) + 
#   scale_color_manual('Case from:', values = c('DIXINN' = 'red',
#                                                    'KALOUM' = 'green',
#                                                    'MATOTO' = 'blue',
#                                                    'MATAM' = 'yellow',
#                                                    'RATOMA' = 'purple',
#                                                    'Not reported' = 'grey'
#                                                    ) 
#                      ) + 
#   geom_text( aes(y = midpoint, ymax=midpoint, label = idnum), size = 2, hjust=0.5) +
  scale_x_date('Week beginning', labels = date_format("%b-%d"),
               breaks = date_breaks("week")) +
  scale_y_continuous('Cases', labels = comma, breaks = seq(2,24,2) ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 2),
       legend.position = 'right' ) +
  facet_grid(SCRes ~ .)
g
```


```{r epicurvecaseswerecontacts_Kin, fig.height=8, fig.width=6.5, fig.cap='Epicurve of cases and known contacts who became cases (colored boxes), Kindia.', include=FALSE}

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
} 

load('kin.keys.rda')
keys = kin.keys

# select one key pair for each case; one pair for each contact
key. = keys %>% 
  group_by(case) %>% filter(row_number(contact)==1) %>%
  group_by(contact) %>% filter(row_number(case)==1) %>% as.data.frame()

sourceCases = key. %>% select(SourceCaseID) %>%
  left_join( data , by = c('SourceCaseID' = 'ID' )) %>%
  merge(Region, all.x = TRUE, by.x= 'District', by.y ='DistrictRes' ) %>%
  rename(sourceSCRes = SCRes) %>%
  select( SourceCaseID, sourceSCRes) %>% unique() 

sourceCases[is.na(sourceCases$sourceSCRes) | 
              sourceCases$sourceSCRes %in% '', 'sourceSCRes'] = 'Missing'
conakry.districts = c('DIXINN','KALOUM' ,'MATAM', 'MATOTO', 'RATOMA')
notConakry = !( toupper(sourceCases$sourceSCRes) ) %in% conakry.districts
notMissing = !( sourceCases$sourceSCRes %in% 'Location missing')
sourceCases[ notConakry &  notMissing, 'sourceSCRes'] = 'Other'

g = 
  data.kindia %>% 
  left_join( key. %>% select(case, SourceCaseID), by = c('ID'= 'case')) %>%
  left_join(sourceCases) %>%
  mutate( idnum = substrRight(SourceCaseID, 4),
          period = as.Date(floor_date(dateOnset, "week")),
          SCRes = ifelse(is.na(SCRes) | SCRes %in% '', 
                         "LOCATION NOT REPORTED", toupper(SCRes)) , 
          sourceSCRes = ifelse(is.na(sourceSCRes) | sourceSCRes %in% '', 
                               "Not a Known Contact", toupper(sourceSCRes))
          ) %>% 
  group_by( period, SCRes, ID ) %>%
  summarize( freq = n() ,
             idnum = idnum,
             sourceSCRes = sourceSCRes) %>%
  mutate( cumsum = cumsum(freq),
          midpoint = (cumsum(freq) - 0.5 * freq)) %>%
  ## plot
  ggplot( aes(x = period , y = freq) ) +
  geom_bar( stat = 'identity', aes( fill=sourceSCRes), color= 'black' ) +
  scale_fill_manual('Source Case from:', values = c('DIXINN' = 'red',
                                                   'KALOUM' = 'green',
                                                   'MATOTO' = 'blue',
                                                   'MATAM' = 'yellow',
                                                   'RATOMA' = 'purple',
                                                   'LOCATION NOT REPORTED' = 'black',
                                                   'OTHER' = 'orange',
                                                   'Not a Known Contact' = 'white'
                                                   ) 
                    ) + 
#   geom_text( aes(y = midpoint, ymax=midpoint, label = idnum), size = 2, hjust=0.5) +
  scale_x_date('Week beginning', labels = date_format("%b-%d"),
               breaks = date_breaks("week")) +
  scale_y_continuous('Cases', labels = comma, breaks = seq(2,26, by=2) ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 2),
       legend.position = 'right' ) 
g

# png('epicurve_secondary_cases.png', height = 7, width = 9.5, units = 'in', res=200)
# g
# dev.off()
```

The number of cases who were known contacts was 35 (`r percent(35/134)`) of 134 total cases in Conakry during September and October, 2014.  During the same period in the five districts of Conakry, the percentage of cases who were known contacts was 42% (5 of 12) in Dixinn, 9% (2 of 23) in Kaloum, 23% (3 of 13) in Matam, 17% (8 of 47) in Matoto, and 31% (11 of 36) in Ratoma (Figure 4). Additionally, we 16% (6 of 38) of cases were known contacts but were missing address data ('Unknown').     

```{r percentcaseswerecontacts, fig.height=4, fig.width=6.5, fig.cap='Epicurve of cases and known contacts who became cases (colored boxes), Conakry.'}

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

load('keys.rda')

# select one key pair for each case; one pair for each contact
key. = keys %>% 
  group_by(case) %>% filter(row_number(contact)==1) %>%
  group_by(contact) %>% filter(row_number(case)==1) %>% as.data.frame()

sourceCases = key. %>% select(SourceCaseID) %>%
  left_join( data , by = c('SourceCaseID' = 'ID' )) %>%
  rename(sourceSCRes = SCRes) %>%
  select( SourceCaseID, sourceSCRes) %>% unique() 

sourceCases[is.na(sourceCases$sourceSCRes) | 
              sourceCases$sourceSCRes %in% '', 'sourceSCRes'] = 'Missing'
conakry.districts = c('DIXINN','KALOUM' ,'MATAM', 'MATOTO', 'RATOMA')
notConakry = !( toupper(sourceCases$sourceSCRes) ) %in% conakry.districts
notMissing = !( sourceCases$sourceSCRes %in% 'Location missing')
sourceCases[ notConakry &  notMissing, 'sourceSCRes'] = 'Other'

g = 
  data.cky %>% 
  left_join( key. %>% select(case, SourceCaseID), by = c('ID'= 'case')) %>%
  left_join(sourceCases) %>%
  mutate( idnum = substrRight(SourceCaseID, 4),
          period = as.Date(floor_date(dateOnset, "week")),
          SCRes = ifelse(is.na(SCRes) | SCRes %in% '', 
                         "UNKNOWN", toupper(SCRes)) , 
          sourceSCRes = ifelse(is.na(sourceSCRes) | sourceSCRes %in% '', 
                               "Not a Known Contact", toupper(sourceSCRes))
          ) %>% 
  group_by( period ) %>%
  summarize( freq = n() ,
             followed = sum(ifelse( !is.na(idnum), 1, 0) / freq)
             ) %>%
  mutate( cumsum = cumsum(freq),
          midpoint = (cumsum(freq) - 0.5 * freq)) %>%
  ## plot
  ggplot( aes(x = period , y = followed) ) +
  geom_bar( stat = 'identity', aes( fill= followed ), color= 'black' ) +
#   geom_text( aes(y = midpoint, ymax=midpoint, label = idnum), size = 2, hjust=0.5) +
  scale_x_date('Week beginning', labels = date_format("%b-%d"),
               breaks = date_breaks("week")) +
  scale_y_continuous('Cases', labels = comma, breaks = seq(0,1,.1)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 2),
       legend.position = 'right' ) 
g

# png('epicurve_secondary_cases.png', height = 7, width = 9.5, units = 'in', res=200)
# g
# dev.off()
```


```{r sourcCases}
load('keys.rda')

# There are a few multiple contact-case pairs do to duplicates. 
# all duplicates have same source case.  The following removes the duplicates
key. = keys %>% 
  group_by(case) %>% filter(row_number(contact)==1) %>%
  as.data.frame()

d = 
  data.cky %>%
  left_join( key.[, 1:2], by = c('ID' = 'case')) %>%
  mutate( knownContact = ifelse(is.na(contact), 'Not Followed*', 'Followed'), 
          daysToIso = as.numeric( as.Date(DateIsolationCurrent) - as.Date(DateOnset) )
          ) %>%
  select( ID, knownContact, daysToIso, ages, HCW, Gender) %>% 
  group_by(knownContact) %>%
  summarize(  n = n(), 
              Age = sprintf("%s", 
                            format(median(floor(ages/12), na.rm = TRUE), nsmall = 1) ),
              Under5 = sprintf("%s%%", 
                            format(round( 100*sum(ifelse(ages/12 <5, 1, 0), na.rm = TRUE)/n, 1) ) ),
              Male = sprintf("%s%%", 
                             round(100*sum(Gender-1, na.rm = TRUE)/n, 1) ) , #1-Masculine, 2-Feminine
              HCW = sprintf( '%s%%', 
                             round(sum(HCW, na.rm = TRUE)/n, 1) ) ,# 0-no, 1-Yes
              Iso = sprintf("%s", 
                            format(mean(daysToIso, na.rm = TRUE), nsmall = 1) )
             )

t = t(d) %>% as.data.frame()
colnames(t) = c('Known Contact', 'Not Known Contact')
rownames(t)[6] = 'Healthcare Worker'
rownames(t)[3] = 'Age: Median (years)'
rownames(t)[4] = 'Age: Under 5 years'
rownames(t)[7] = 'Days to Isolation (median)'

t = t[-c(1,7), ]  # take off row that is now the header (1) and days to isolation (7)

kable( t, align = c('r', 'r'), 
       digits = 1, 
       caption = 'Characteristics of EVD cases who were known contacts' )

# test of significance for under 5
d = 
  data %>%
  left_join( key.[, 1:2], by = c('ID' = 'case')) %>%
  mutate( knownContact = ifelse(is.na(contact), 'Not Followed*', 'Followed'), 
          Under5 = ifelse(ages/12<5, 'under5', 'over5') 
          )

t = table(d$Under5, d$knownContact)
f = fisher.test(t)

```

```{r secondarycasescky, fig.cap = 'Histogram of the number of secondary cases associated with source cases.', fig.height= 3}

load('keys.rda')

# There are a few multiple contact-case pairs do to duplicates. 
# all duplicates have same source case.  The following removes the duplicates
key. = keys %>% 
  group_by(case) %>% filter(row_number(contact)==1) %>%
  as.data.frame()

# key. %>% filter(dateOnset %within% SeptemberOctober ) %>% count(contact)

sourceCases = key. %>% 
  filter(dateOnset %within% SeptemberOctober ) %>% 
  select(SourceCaseID) %>%
  count(SourceCaseID) %>%
  left_join( data , by = c('SourceCaseID' = 'ID' )) %>%
  rename(sourceSCRes = SCRes,
         Secondary = n) %>%
  arrange(-Secondary) %>%
  unique() %>%
  mutate( CaseID = LETTERS[1:12],
          Outcome = ifelse(StatusReport ==1, 'Died', 'Alive'),
          Hospitalized = ifelse( !is.na(DateHospitalCurrentAdmit), 'Y', 'N'),
          Age = floor(ages/12))  %>%
  select( SourceCaseID,
          CaseID, DistrictRes, sourceSCRes, dateOnset, Gender, 
          Age, HCW, Hospitalized, Outcome, Secondary) 

# sourceCases[is.na(sourceCases)] = 0

kable(sourceCases %>% select(-SourceCaseID), 
      align = 'r', caption = 'Characteristics of source cases', row.names = FALSE)

sourceCases[is.na(sourceCases$sourceSCRes), 'sourceSCRes'] = 'Missing'
  
john.ben.interval = new_interval(ymd("2014-Aug-1"), ymd("2014-OCT-30"))

t = key. %>% 
  filter(dateOnset %within% john.ben.interval ) %>%
  count(SourceCaseID) %>%
  arrange(-n) %>%
  rename(Number_2ndary_Cases = n)

# kable(t)

g = t %>% filter(!is.na(t$SourceCaseID)) %>%
ggplot(aes(x=Number_2ndary_Cases )) +
  geom_bar() +
  scale_y_continuous('Frequency') +
  scale_x_continuous('Number of secondary cases', 
                     breaks = seq(1, max(t$Number_2ndary_Cases), 2)
                     ) 
g

# r=naught
secondary = sum(t$Number_2ndary_Cases, na.rm=T)
sources = sum(!is.na(t$SourceCaseID))

noSpread = data.cky[data.cky$dateOnset <= max(sourceCases$dateOnset, na.rm = TRUE) ,] %>%
  filter( !(ID %in% sourceCases$SourceCaseID)) %>%
  nrow()

r0max =  secondary  / sources
r0min = secondary  / (sources + noSpread)

# effect of reducing superspreader to only one secondary case
r0prime = (secondary - 9) / sources


```

There were only 15 source cases for the 35 secondary cases identified.  From these, we estimate a reproductive number between `r round(r0max, 1)` and `r round(r0min, 1)`.  The maximum reproductive number was estimated from only those cases with a secondary case (Figure 3); the minimum was estimated when including all cases for whom no secondary cases were identified.

```{r isolationg, warning=FALSE}

cky.kin = rbind(data.cky, data.kindia)

load('keys.rda')

# There are a few multiple contact-case pairs do to duplicates. 
# all duplicates have same source case.  The following removes the duplicates
key. = keys %>% 
  group_by(case) %>% filter(row_number(contact)==1) %>%
  as.data.frame()

d = 
  data.cky %>%
  left_join( key.[, 1:2], by = c('ID' = 'case')) %>%
  mutate( knownContact = ifelse(is.na(contact), 'Not Followed*', 'Followed'), 
          daysToIso = as.numeric( as.Date(DateIsolationCurrent) - as.Date(DateOnset)),
          daysToIso = ifelse(daysToIso < 1 , NA, daysToIso ),
          iso3 = ifelse(daysToIso <= 3 , 1, 0)
          ) %>%
  select( ID, knownContact, daysToIso, iso3, DateIsolationCurrent, DateOnset, DateReport)

g = ggplot(d, aes( knownContact , daysToIso)) +
#     scale_x_continuous('Month', breaks = c(1:12)) +
    scale_y_continuous('Days to Isolation', breaks = seq(0, 28, 2)) +
    geom_point( position = 'jitter' ) +
#     scale_colour_manual('Status', values = c('grey', "green", "red")) +
    geom_boxplot( aes(group = knownContact) , outlier.shape = NA, fill = NA)  
# g

#Significance

followed = mean(d[ d$knownContact %in% 'Followed', 'daysToIso'], na.rm=TRUE)
not.followed = mean(d[ d$knownContact %in% 'Not Followed*', 'daysToIso'], na.rm=TRUE)

followed.iso3 = mean(d[ d$knownContact %in% 'Followed', 'iso3'], na.rm=TRUE)
not.followed.iso3 = mean(d[ d$knownContact %in% 'Not Followed*', 'iso3'], na.rm=TRUE)

# t.test( daysToIso ~ factor(knownContact), data = data[!is.na(data$daysToIso),])
library("BayesianFirstAid")
# bayes.test = bayes.t.test( daysToIso ~ factor(knownContact), data = d[!is.na(d$daysToIso),])
```

The percentage of patients who were isolated within 3-days of illness onset was greater for those that were known contacts (`r percent(followed.iso3)`) than for those that were not known contacts (`r percent(not.followed.iso3)`).  

# Transmission Chains

The superspreader highlighted in this report accounted for 10 (`r percent(10/31)`) of 31 secondary cases.  Information on the relationships between these cases was missing from the database.  These could be systematically collected, but this requires additional resources and it may be as effective to investigate this cluster after the fact to determine the factors contributing to superspreading.  As there are relatively few superspreaders who contribute to a large number of cases, it would be resource-effective to restrict additional resources to investigation of the superspreading events highlighted through analysis of routine surveillance data.  

```{r superspreaderSecondary}

d = # primary case data
  data.cky %>%
  filter(ID %in% 'GUI-CKY-14-1365') %>%
  select(Gender, ages, DateHospitalCurrentAdmit, StatusAsOfCurrentDate, DateDeath, PlaceDeath,
         ContactName1, ContactRelation1, HCW)

load('contacts.rda') # see cky_case_contacts.Rmd
e = contacts %>%
  filter( SourceCaseID %in%  'GUI-CKY-14-1365')

f = contacts[, c('ID', 'DateLastContact', 'SourceCaseID')] %>%
  left_join(key.[, c('contact', 'case')] , by = c('ID' = 'contact') ) %>%
  left_join(data.cky[, c('ID', 'ages', 'dateOnset', 'Gender','HCW', 'SCRes')] , 
            by = c('case' = 'ID') ) %>%
  filter( SourceCaseID %in%  'GUI-CKY-14-1365') %>%
  mutate( incubation = dateOnset - DateLastContact)
  
  kable( f %>%
    summarise(  n = n(), 
              Age = sprintf("%s", 
                            format(median(floor(ages/12), na.rm = TRUE), nsmall = 1) ),
              Under5 = sprintf("%s%%", 
                            format(round( 100*sum(ifelse(ages/12 <5, 1, 0), na.rm = TRUE)/n, 1) ) ),
              Male = sprintf("%s%%", 
                             round(100*sum(Gender-1, na.rm = TRUE)/n, 1) ) , #1-Masculine, 2-Feminine
              HCW = sprintf( '%s%%', 
                             round(sum(HCW, na.rm = TRUE)/n, 1) ) ,# 0-no, 1-Yes
              inc = sprintf("%s", 
                            format(mean(incubation, na.rm = TRUE), nsmall = 1) ),
              incmin = sprintf("%s", 
                            format(min(incubation, na.rm = TRUE), nsmall = 1) ),
              incmax = sprintf("%s", 
                            format(max(incubation, na.rm = TRUE), nsmall = 1) )
             ),
    caption = 'Characteristics of Cases Associatied with Case A')
  
```

Case A, who was the source of infection for 10 confirmed EVD cases was a 40 year old woman whose symptoms included fever and joint pain. According to the case report form, her illness onset, hospitalization, laboratory confirmation of EVD, and death were all on September 2, 2014.  She did not report having contact with a known case and was not a healthcare worker. Case investigators identified 72 persons (Table 4.) who directly touched, ate with, or lived with Case A when she was ill. Of these 12 (`r percent(10/72)`) became confirmed cases from 7 to 21 days after last exposure.  Of these, 7 of had onset close to 3-weeks after last exposure and may signal that there was another (unidentified) case with whom these contacts were exposed.   


```{r igraphChain, fig.cap='Transmission from Case A to ten secondary cases (Case A in black;  secondary female cases in dark grey; secondary male cases in light grey)' }

# igraph

load('keys.rda')


# Case-ContactName should refer to same person as contact's SourceCase
# edges %>% select(caseID,  contactID, ContactName1, SourceCase) %>% filter(!is.na(ContactName1)) %>% arrange(caseID, contactID)

igraphChain = function( .keys = keys, 
                        cases = data, 
                        sourceID = NA ,
                        xaxis = 'incubation',
                        .xlim = c(0, 30),
                        .ylim = c(0, 80),
                        yaxis = 'Age',
                        title = '',
                        edge.var = NA,
                        table = FALSE,
                        curve = .05
                        ){

# select columns that will be used for display
case.cols = c('ID', 'Surname','OtherNames', 'Age', 'Gender' , 'DistrictRes', 'SCRes', 'VillageRes', 
              'DateOnset', 'dateOnset',
              'ContactName1', 'ContactName2')

contact.cols = c('ID', 'DateLastContact', 'SourceCase', 'SourceCaseID', 'HeadHousehold', 'RelationshipToCase')

# edge list
edges = .keys %>% 
  inner_join(cases[, case.cols], by = c('caseID' = 'ID')) %>%  # excludes non-cases
  inner_join(contacts[, contact.cols], by = c('contactID' = 'ID')) %>% 
  mutate( case = caseID , 
          source = SourceCaseID ,
          RelationshipToSource = RelationshipToCase,
          incubation = as.Date(dateOnset) - as.Date(DateLastContact),
          incubation = ifelse(is.na(incubation), 10, incubation) 
          ) %>% 
  filter( !(case == source) ) %>%
  select( source, case , score, incubation, Age, Gender, DistrictRes, SCRes, VillageRes, 
          dateOnset, DateOnset, HeadHousehold, RelationshipToSource) %>%
  unique()  # may have multiple edeges because of duplicate contacts

if (!is.na( sourceID) ){ edges = edges %>% filter(source %in% sourceID) %>% arrange(case, score)}

nodes = unique( c(edges[,1], edges[,2]))
nodes. = data.frame( case = nodes )

# list sources who are not cases
sources =  anti_join( nodes. , edges, by='case') %>% 
  inner_join(cases[, case.cols], by = c('case' = 'ID')) %>%
  select( case , Age, Gender, DistrictRes, SCRes, VillageRes, 
          dateOnset, DateOnset) %>%
  mutate( incubation = 0,
          source = NA,
          score = NA ,
          HeadHousehold = NA,
          RelationshipToSource = NA
          )

node.data = rbind(sources, edges)

# replace missing age with 35
node.data[ is.na(node.data$Age), 'Age'] = 35

library(igraph)
A.vertices = as.matrix(node.data[, c(xaxis, yaxis)])
A =  edges %>% graph.data.frame(directed = TRUE, vertices = nodes)
v.colors = ifelse(node.data$Gender == 1, '#377eb8', '#4daf4a')
v.colors[ node.data$ID %in% sourceID ] = 'black'

library(RColorBrewer)
palette = c('#8dd3c7', '#bebada', '#fb8072', '#80b1d3', 'gray') 
if ( edge.var %in% colnames(edges)){
  e.levels = levels(factor(edges[, edge.var] ))
  e.colors = palette[ match(edges[, edge.var] , e.levels, nomatch = 5)]
} else { e.colors = 'dark grey'}

plot(A, layout = A.vertices, 
              axes = T , main = title,  asp = 0,
              xlim = .xlim, ylim = .ylim, rescale = FALSE, 
              xlab = 'Days from Last Contact with Source Case to Illness Onset', 
              ylab = 'Age (yrs)',
              vertex.label = NA, vertex.size = 100, vertex.label.cex = 0.8,
              vertex.color = v.colors, 
              edge.color = e.colors,
              edge.curved = curve*(-1)^(0:length(edges)) ,
              edge.arrow.size = 0.5)

if (table){ kable(edges, rownames = FALSE)}

}

```

```{r chainA, fig.cap='Transmission from sources to secondary cases.  Position of cases is plotted as the days from last exposure to onset along the x-axis (for clarity, the source cases is placed at 0) and age in years along the y axis. Circles: Blue = Male; Green = Female. Arrows with same color indicates same household'}

# case A
igraphChain(sourceID = 'GUI-CKY-14-1365', title = 'Patient A Transmission', edge.var = 'HeadHousehold')
```

```{r chainb, fig.cap='Transmission from sources to secondary cases.  Position of cases is plotted as the days from last exposure to onset along the x-axis (for clarity, the source cases is placed at 0) and age in years along the y axis. Circles: Blue = Male; Green = Female. Arrows with same color indicates same relationship from source case to secondary case: Blue = nurse'}

# case B 
igraphChain(sourceID = 'GUI-COY-14-0003', title = 'Patient B Transmission', edge.var = 'RelationshipToSource')

```

```{r chainc, fig.cap='Transmission from sources to secondary cases.  Position of cases is plotted as the days from last exposure to onset along the x-axis (for clarity, the source cases is placed at 0) and age in years along the y axis. Reatationship and household data unavailable'}

# case C
igraphChain(sourceID = 'GUI-KER-14-3034', title = 'Patient C Transmission', edge.var = NA)
  
```


# Discussion

Contact tracing programs are an essential mechanism to provide prompt admission of EVD cases to treatment centers. With facilities available for effective isolation and treatment, it is critical to follow contacts of all known cases diagnosed for 21 days. A critical metric for monitoring the success of outbreak control through contact tracing is to identify the number of new cases who were known contacts and that were being monitored daily. Ideally, all new cases would be identified through contact tracing. 

In practice, many programs report the percentage of contacts that were followed each day. While completiong of contact tracing is necessary, it may not be sufficient if contacts were not accurately identified and reported to the contact tracing teams.  It is also possible that 99% of contacts are being followed but the ones who go on to develop disease are not.  Moreover, new chains of transmission could occur apart from those already identified.  

Given the large number of contacts, documenting daily visits in a registry that can be evaluated for program evaluation is challenging, and is not done.  Rather, supervisors inquire verbally whether contact teams have reached all their assigned contacts. Typically this percentage is reported at levels approaching or reaching 100%.  A more practical and effective approach would be to confirm that all new cases were known contacts being followed daily. All new cases that were not known contacts being followed daily should prompt an investigation to identify gaps in the contact tracing programs.  

Analysis of data presented here suggests that there were a large number of new EVD cases that were not being followed as contacts.  If true, these patients represent a missed opportunity to limit transmission through effective isolation and provide medical care.  However, data were not collect to directly asses whether new cases were known contacts and this retrospective analysis is limited by the data available, particularly the incomplete list contacts entered into the national Ebola database. The national database may be incomplete because: 1) patients were unable or unwilling to identify persons with whom they had contact after illness onset, 2) contact information was transmitted first to the local public health officials responsible for contact tracing and may not have been transmitted to the national VHF database, and 3) a new national registry of contacts was created in mid-October and entry into the national VHF database was stopped.  

As expected, the number of days from illness onset to isolation was less for those who were know contacts than for others, although the difference was not as large as could be expected.  The smaller than expected difference may be due to data misclassification: some contact teams may have been following contacts that were either not entered into the VHF database or who were not able to be matched to ther subsequent case report. More importantaly, even when followed, some patients refused access by community agents and were unwilling to go to the ETU. For example, there was one extended family who refused access by community agents, resulting in delayed isolation and testing of 19 suspected EVD cases, all of whom subsequently confirmed cases after a community health agent was successful in convincing the family to participate in follow up visits for 21-days and to send ill patients to the ETU.  

Constructing chains of transmission diagrams permits an understanding of how and where transmission is occurring. We found that all new cases were geographically concentrated among families. Thus transmission was not diffuse and reassured us that there were not unknown chains of transmission. Despite rising case counts initially, continued contact tracing should lead to dramatic reduction in new cases. (As contact tracing becomes effective, R0 likely to have apparent increase; models of increasing case counts should be interpreted with caution during this period.) Supervision and monitioring of contact tracing teams should include reconstructing chain of transmission diagrams. Visualizing chain of transmission provides feedback on the importance of contact tracing and helps assure accurate information is being gathered. 

Some information was also available for Kindia, the Region adjacent to Conakry, which has two districts just outside of Conakry.  We were able to find only 4 of 71 cases who were known contacts.  (These four cases were linked to three source cases).  This may signify that more effort is needed to strengthen contact tracing and reporting in the districts adjacent Conakry.  Contact data from the forrest region is maintained outside of the national VHF database and was not available for this analysis.  

Case investigation forms provide details of possible sources of transmission to the current patient. More importantly, it provides names of contacts who may have been exposed. As is shown in this report, this may be linked with case report forms to monitor contact tracing coverage and to better understand transmission.  Combining case and contact data into one database with a strong database link between case and contact would be ideal. Alternatively, cases and contacts registries having key personally identifiable information on both registries could be linked. This could also be acheived by documenting on the case report form whether the case had been interviewed by a contact tracing team and whether the new case was reported by contact tracing programs.      

Contact tracing has been successful in interrupting transmission of EVD in Senegal and Nigeria.^[reference senegal and nigeria...].  However, those two countries had a relatively small number of EVD cases and contacts. Scaling contact tracing operations to a larger outbreak is logistically challenging. In September and October, contact tracing teams were hampered by transportation problems.  It was frequently reported that contact tracers had not recieved pay and were nonetheless using personal funds to purchase gas inorder to make the daily visits to contacts across the city.  These anectdotes highlights the number of persons committed to effective public health practice.  Efforts to create a system with effective and timely support for contact tracing is ongoing, and novel methods may be needed. Contact tracing teams critical to control of outbreak and should be strengthened.


```{r case_counts}

x = data %>% 
  filter(dateOnset %within% SeptemberOctober )   %>% 
  count(Region, month) %>% as.data.frame() %>%
  mutate( month = factor(month, levels = c('September', 'October'), order = T),
         Region = ifelse( is.na(Region), 'Unknown', Region) ) 
                

# Region %in% c('Conakry', 'Coyah', "N'Zerekore") &

y = x %>%  spread(month, n)
t = data.frame(Region = 'Total', 
               September = sum(y$September, na.rm=T) , 
               October = sum(y$October, na.rm=T))
y = rbind(y, t)

y[is.na(y)] = 0

# y = rbind(y, data.frame(Region = 'total', data %>% count()) )
kable( comma(y), align = c('l', rep('r', ncol(y)-1)), caption = 'New EVD cases identified in Guinea, September-October, 2014.' )
```

```{r epicurve, fig.cap='Weekly EVD Case Count in Conakry and Kindia, Guinee, September-October, 2014'}

#kindia geography

# data.kindia %>%  count(DistrictRes, ParishRes, SCRes, VillageRes)
  
cky.kin = data %>% filter(Region %in% c('Conakry', 'Kindia') )

# facet by region; fill by prefecture
# SClevels = unique(toupper(cky.kin[order(cky$Region, cky$SCRes), 'SCRes']))

#  cky = cky %>%
#   mutate( 
#     SCRes = factor( toupper(SCRes), levels = SClevels) )
  
cky.kin %>%
  filter(dateOnset %within% SeptemberOctober ) %>% 
  arrange(dateOnset) %>%
  mutate( interval = week(dateOnset),
          period = as.Date(floor_date(dateOnset, "week")) ) %>%  # set time period
  group_by( Region, period ) %>%
  summarize( freq = n() ) %>%  
  ggplot( aes(x = period , y = freq, fill = Region) ) +
  geom_bar( stat = 'identity', color = 'white') +
  scale_x_date('Week', labels = date_format("%b-%d"),
               breaks = date_breaks("week")) +
  scale_fill_brewer('', palette="Set3", guide=FALSE) +
  ylab('Cases') + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1) ) +
#   scale_fill_manual(values = c('red', 'blue', 'yellow')) +
  facet_grid( Region ~ .)


```


```{r gadm_map_data}

# Get GADM rdata files

# see
# http://stackoverflow.com/questions/5126745/gadm-maps-cross-country-comparision-graphics

## load a file from GADM (you just have to specify the countries "special part" of the file name, like "ARG" for Argentina. Optionally you can specify which level you want to have
loadGADM <- function (fileName, level = 1, ...) {
  # load files downloaded from gadm
  load(paste(fileName, "_adm", level, ".RData", sep     = ""))
  gadm
}

## the maps objects get a prefix (like "ARG_" for Argentina)
changeGADMPrefix = function (GADM, prefix) {
  GADM <- spChFIDs(GADM, paste(prefix, row.names(GADM), sep = "_"))
  GADM
}

## load file and change prefix
loadChangePrefix = function (fileName, level = 0, ...) {
  theFile <- loadGADM(fileName, level)
  theFile <- changeGADMPrefix(theFile, fileName)
  theFile
}

## this function creates a SpatialPolygonsDataFrame that contains all maps you specify in "fileNames".
## E.g.: 
## spdf <- getCountries(c("ARG","BOL","CHL"))
## plot(spdf) # should draw a map with Brasil, Argentina and Chile on it.

getCountries = function (fileNames, level = 0, ...) {
  polygon <- sapply(fileNames, loadChangePrefix, level)
  polyMap <- do.call("rbind", polygon)
  polyMap
}


tolerance = .01
country = "GIN"

     gadm = getCountries(country, level=3)
     gadm.f = as.data.frame(gadm) 

    # make list of regions, prefectures, sous prefectures
    regions = gadm.f %>% select(NAME_1,NAME_2,NAME_3) 
    colnames(regions) = c('Region', 'DistrictRes', 'SCRes')

     # fix name of capital in GADM file!
     regions[regions$DistrictRes == 'Conarky', 'DistrictRes'] = 'Conakry'
     regions[regions$Region == 'Conarky', 'Region'] = 'Conakry'

save(regions, file = 'regions.rda')
     
     GIN3 = gadm %>%
#             gSimplify(tolerance, topologyPreserve=T) %>%
            fortify(region = "ID_3") %>%
            mutate( id = as.integer(id)) %>%
            reshape::rename(c("id" = "ID_3")) %>%  #explicit call to rename function in reshape package (as opposed to rename function in plyr package)
            left_join(
              gadm.f[, c("ID_3", "NAME_1", "NAME_2", "NAME_3")])

# fix name of capital in GADM file!
GIN3[GIN3$NAME_2 == 'Conarky', 'NAME_2'] = 'Conakry'

# get location and names for labels
# Admin 3 labels 

          Names = gadm.f %>% 
               select( which(colnames(gadm.f) =="NAME_3"),
                       which(colnames(gadm.f) == "TYPE_3")
               )

          
          GIN3.c =  gadm %>%
                       coordinates()  %>%
                       as.data.frame() %>%
                       mutate(Name = Names[,'NAME_3'],
                              Type = Names[,'TYPE_3']
                              )
# fix name of capital in GADM file!
GIN3.c[GIN3.c$Name == 'Conarky', 'Name'] = 'Conakry'

# Admin 2

     gadm = getCountries(country, level=2)
     gadm.f = as.data.frame(gadm) 

     GIN2 = gadm %>%
#             gSimplify(tolerance, topologyPreserve=T) %>%
            fortify(region = "ID_2") %>%
            mutate( id = as.integer(id)) %>%
            reshape::rename(c("id" = "ID_2")) %>%
            left_join(
              gadm.f[, c("ID_2", "NAME_1", "NAME_2")])

# fix name of capital in GADM file!
GIN2[GIN2$NAME_2 == 'Conarky', 'NAME_2'] = 'Conakry'

# Admin 2 labels

          Names = gadm.f %>% 
               select( which(colnames(gadm.f) =="NAME_2"),
                       which(colnames(gadm.f) == "TYPE_2")
               )
 
          GIN2.c =  gadm %>%
                       coordinates()  %>%
                       as.data.frame() %>%
                       mutate(Name = Names[,'NAME_2'],
                              Type = Names[,'TYPE_2']
                              ) 

# fix name of capital in GADM file!
GIN2.c[GIN2.c$Name == 'Conarky', 'Name'] = 'Conakry'

```

```{r gadmNames, eval=FALSE}
gin.names = unique( GIN3[, c('NAME_1', 'NAME_2', 'NAME_3') ])
write.csv(gin.names, file='GuineaNames.csv', row.names=FALSE, fileEncoding = 'UTF-8')

```

```{r theme_defaults}
theme_bare = theme(line = element_blank(),
                   text = element_blank(),
                   line = element_blank(),
                   title = element_blank())

# aesthetic defaults...
color.brewer = "BuPu"  # "YlGnBu" , 'PuBu'  'Greys' (http://colorbrewer2.org/)
zero.color = 'white' # add color for cells with zero counts
background.color = 'grey99' 
county.border.color = 'grey70' 
state.border.color = 'grey45'
legend.placement = c(.5, -.05)  
legend.font.size = 11 

theme_map =  # coord_map() +
     theme(
          legend.position = legend.placement,
          legend.direction = 'horizontal',
          legend.background = element_blank(),
          legend.title=element_text(size=legend.font.size),
          legend.text = element_text(size=legend.font.size),
          panel.grid.major=element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.ticks = element_blank(),
          axis.text = element_blank(),
          panel.border = element_blank(),
          strip.background = element_rect(colour=background.color, 
                                          fill=background.color),
          panel.background = element_rect(fill=background.color),
          plot.margin = unit(c(0,0,2,0),"cm") # remove plot margins
     )
```

```{r tab_district, results='asis'}

load('regions.rda')
Region = regions %>%  # table includes Region, DistrictRes, SCRes
  select(-SCRes) %>% # remove SCRes
  unique()

# Add indicator for counting cases
load('cases.guinea.rda')
cases.guinea$case = 1

d = cases.guinea %>% 
  mutate( DistrictRes = ifelse( DistrictRes %in% '', NA, DistrictRes)) %>%
  merge(Region, all = TRUE, by= 'DistrictRes') 

d.sepoct = cases.guinea %>% 
  filter(dateOnset %within% SeptemberOctober ) %>%
  mutate( DistrictRes = ifelse( DistrictRes %in% '', NA, DistrictRes)) %>%
  merge(Region, all = TRUE, by= 'DistrictRes') 
  
d.previous = cases.guinea %>% 
  filter(dateOnset < as.Date(ymd('2014-SEP-01')) ) %>%
  merge(Region, all = TRUE, by= 'DistrictRes')

p.total = d %>%
  group_by(DistrictRes) %>% 
  summarize(Total = sum( case, na.rm = TRUE)) 

p.sepoct = d.sepoct %>%  # tabulate totals by location
  group_by(DistrictRes ) %>% 
  summarize( SepOct = sum( case, na.rm = TRUE)) 

p.previous = d.previous %>%  # tabulate totals by location
  group_by(DistrictRes ) %>% 
  summarize( previous = sum( case, na.rm = TRUE)) 

p.previous = rbind(p.previous, data.frame(DistrictRes = NA, previous=NA))
p.previous[is.na(p.total[,1]), 1 ] <- 'Unknown'


p = cbind(p.sepoct, p.previous[,2], p.total[,2]) # join TOTALS to t

p[is.na(p[,1]), 1 ] <- 'Unknown'

p[is.na(p)] <- 0  # convert NA to 0

# kable(p)  # print table

```

```{r prefets_dot, fig.cap="Cas d'Ebola pendant le dernier 21 jours, Guinee", fig.height=8, fig.width=6.5}

# classify values
p$SepOct =  cut(p$SepOct, 
                      breaks = c(0, 1, 5, 10, 20, 50, Inf), 
                      label = c('0','1-4','5-9','10-19', '20-49', '50+'),
                      right=FALSE, include.lowest=TRUE)


# classify totals 
p$previous =  cut( p$previous, 
                      breaks = c(0,1,10, 20, 50, 100, Inf), 
                      label = c('0','1-9','10-19','20-50','50-100', '100 +'),
                      right=FALSE, include.lowest=TRUE)

# Join data with map
p$NAME_2 = p$DistrictRes
map.data.p = merge(GIN2, p, all.x=TRUE, 
                 by.y='NAME_2', by.x = 'NAME_2') %>%
  merge(GIN2.c, all.x = TRUE) %>%
  arrange(order) 

map.data.p.c = merge(GIN2.c, p, all.x=TRUE, by.y='NAME_2', by.x = 'Name') 

color.brewer ="YlOrBr" # "Purples" # 
colors = brewer.pal(6, color.brewer)  # fill colors

g = ggplot( ) + theme_map +
  geom_polygon(data= map.data.p,
               aes(x=long, y=lat, group=group, 
                   fill=previous), 
               color="grey50", alpha=1) + 
  geom_text(data= GIN2.c, aes(label = Name, x=V1, y=V2), size=4, vjust = 2) +
  scale_fill_manual('Cases through August, 2014', values = colors, drop = FALSE) +
  geom_point(data= map.data.p.c, aes(x=V1, y=V2, size = SepOct, alpha = SepOct), 
             color = "red") + # maroon ""
  scale_size_discrete("Cases During September-October, 2014") +
  scale_alpha_discrete("Cases During September-October, 2014")
g

ggsave('SepOct.png', width=6.5, height=6.5, units='in')
```

